import{d as q,E as z,c as h,h as b,e7 as p,K as V,i as K,bs as Y,r as S,e as _,o as m,w as s,q as y,j as v,a as C,f as o,m as H,k as c,t as g,_ as x,Q as j,a6 as J,v as W,F as X,b as Z,x as ee,ae,bt as le}from"./index-jY1EWd09.js";import{a as te}from"./guilds-CRHZJ8UJ.js";import{_ as B}from"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-CqJL3vnO.js";import{_ as oe}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CTycXHot.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CYiRxbPX.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-CihjvaoM.js";import"./index-qe4CXcF2.js";const se={key:0,class:"tw-flex tw-items-center tw-justify-between tw-text-sm"},re={class:"tw-text-neutral-400"},ie={key:0},ne={key:1,class:"text-muted mb-3 small tw-pt-4 tw-text-center tw-italic"},be=q({__name:"GuildActionChangeRole",props:{guildId:{}},setup(G){const M=G,$=Y(),{data:u,refresh:P}=z(te(M.guildId)),O=h(()=>Object.keys(u.value.model.members).length!==0),f=b([]);function D(t,e){return t.filter(n=>{const d=e.toLocaleLowerCase();return n.value?!!(n.value.displayName.toLocaleLowerCase().includes(d)||n.value.playerId.toLocaleLowerCase().includes(d)||n.value.roleId.toLocaleLowerCase().includes(d)):!1})}const l=b(),E=h(()=>["Leader","MiddleTier","LowTier"].map(t=>({label:p(t),value:{id:t,displayName:p(t)},disabled:l.value?.roleId===p(t)}))),r=b(),w=b(),i=b(),R=b(!1),T=h(()=>f.value.length===1?"This guild has only one member. You cannot change their role.":l.value?r.value?w.value?void 0:"Change is not valid.":"Select a role to proceed.":"Select a player to proceed.");function A(){l.value=void 0,r.value=void 0,w.value=void 0,i.value=void 0;const t=[];for(const e in u.value.model.members){if(!Object.prototype.hasOwnProperty.call(u.value.model.members,e))continue;const n=u.value.model.members[e];t.push({label:e,value:{playerId:e,displayName:n.displayName,roleId:p(n.role)}})}f.value=t,f.value.length===1&&f.value[0]&&(l.value=f.value[0].value)}V(l,I),V(r,I),K(I);async function I(){if(i.value=void 0,w.value=void 0,l.value&&r.value){R.value=!0;const t=await $.post(`/guilds/${u.value.id}/validateEditRole`,{playerId:l.value.playerId,role:r.value.id}),e=t.data.changes;i.value=[],Object.entries(e).forEach(n=>{const[d,k]=n;i.value.push({playerId:d,newRole:k,displayName:u.value.model.members[d].displayName||"n/a",oldRole:u.value.model.members[d].role});const a=i.value.findIndex(L=>L.playerId===l.value?.playerId);if(a>0){const L=i.value[a];i.value.splice(a,1),i.value.unshift(L)}}),Object.keys(e).length>0&&(w.value=t.data),R.value=!1}else l.value||(r.value=void 0)}const{showSuccessNotification:F}=le();async function Q(){await $.post(`/guilds/${u.value.id}/editRole`,{playerId:l.value?.playerId,role:r.value?.id,expectedChanges:w.value?.changes}),F(`${l.value?.displayName} is now a ${r.value?.displayName}.`),P()}function N(t){return t==="Leader"?"primary":"neutral"}const U=h(()=>u.value.model.lifecyclePhase==="Closed"?"Guild is closed.":O.value?void 0:"Guild has no members.");return(t,e)=>{const n=S("b-spinner"),d=S("b-row"),k=S("fa-icon");return m(),_(o(oe),{"modal-title":"Change a Guild Member's Role",action:Q,"trigger-button-label":"Change a Role","trigger-button-disabled-tooltip":U.value,"ok-button-label":"Change Role","ok-button-disabled-tooltip":T.value,permission:"api.guilds.edit_roles",onShow:A,"data-testid":"action-change-role"},{default:s(()=>[e[6]||(e[6]=y("div",{class:"tw-mb-1 tw-font-semibold"},"1. Select a Guild Member",-1)),v(o(B),{"model-value":l.value,options:f.value,"search-function":D,placeholder:"Select a player...","onUpdate:modelValue":e[0]||(e[0]=a=>l.value=a)},{option:s(({option:a})=>[a.value?(m(),C("div",se,[y("span",null,[c(g(a.value?.displayName)+" ",1),v(o(x),{variant:N(a.value.roleId)},{default:s(()=>[c(g(o(p)(a.value.roleId)),1)],void 0,!0),_:2},1032,["variant"])]),y("span",re,g(a.value.playerId),1)])):H("",!0)]),_:1},8,["model-value","options"]),y("div",{class:j(["tw-font-semibold tw-my-3",{"tw-text-neutral-400":!l.value}])},"2. Select a New Role",2),v(o(B),{"model-value":r.value,options:E.value,placeholder:l.value?"Select a role...":"Select a guild member first",disabled:!l.value,"onUpdate:modelValue":e[1]||(e[1]=a=>r.value=a)},null,8,["model-value","options","placeholder","disabled"]),y("div",{class:j(["tw-mb-1",["tw-my-3 tw-font-semibold",{"tw-text-neutral-400":!l.value||!r.value}]])},"3. Preview Role Changes",2),R.value?(m(),C("div",ie,[v(d,{class:"justify-content-center mt-5"},{default:s(()=>[v(n,{class:"mt-4",label:"Loading..."})],void 0,!0),_:1})])):i.value?i.value.length==0?(m(),_(o(J),{key:2,title:"No Changes to Roles"},{default:s(()=>[...e[2]||(e[2]=[c("This change is no-op, invalid, or the resulting guild state would break the role invariants. Contact Metaplay if you think this is a bug!",-1)])],void 0,!0),_:1})):(m(),_(o(W),{key:3,showBorder:""},{default:s(()=>[(m(!0),C(X,null,Z(i.value,a=>(m(),_(o(ee),{class:"tw-px-5",key:a.displayName},{"top-right":s(()=>[v(o(ae),{to:`/players/${a.playerId}`},{default:s(()=>[...e[3]||(e[3]=[c("View player",-1)])],void 0,!0),_:1},8,["to"])]),"bottom-left":s(()=>[e[4]||(e[4]=c("Role will be changed from ",-1)),v(o(x),{variant:N(a.oldRole)},{default:s(()=>[c(g(o(p)(a.oldRole)),1)],void 0,!0),_:2},1032,["variant"]),e[5]||(e[5]=c(" to ",-1)),v(o(x),{variant:N(a.newRole)},{default:s(()=>[c(g(o(p)(a.newRole)),1)],void 0,!0),_:2},1032,["variant"])]),default:s(()=>[y("span",null,[v(k,{icon:"user"}),c(" "+g(a.displayName||"n/a"),1)])],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})):(m(),C("div",ne,"Choose a player and a role to preview the results."))],void 0,!0),_:1},8,["trigger-button-disabled-tooltip","ok-button-disabled-tooltip"])}}});export{be as default};
