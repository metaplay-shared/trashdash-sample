import{d as R,E as q,h as s,c as J,r as U,e as E,m as w,f as r,o as u,I as z,w as y,j as _,q as m,a as k,a6 as $,k as d,F as H,b as L,t as x,bl as Y,_ as K,bJ as P,cD as N,bs as Q,bt as W}from"./index-jY1EWd09.js";import{a as X}from"./players-Dfl1Givn.js";import{_ as Z}from"./MInputTextArea.vue_vue_type_script_setup_true_lang-BahEDGWU.js";import{_ as ee}from"./MInputSingleFileContents.vue_vue_type_script_setup_true_lang-yY85JcDy.js";import{_ as ae}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CTycXHot.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CYiRxbPX.js";import"./debounce-DkFP0rfT.js";import"./isSymbol-B-tfGeoT.js";import"./MInputSingleFile-DnTld9Jz.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-CihjvaoM.js";import"./index-qe4CXcF2.js";const te={class:"tw-mb-2"},re={class:"tw-mr-1"},le={key:3,class:"code-box text-monospace tw-max-w-lg tw-rounded-md tw-border tw-border-neutral-200 tw-bg-neutral-100 tw-text-neutral-600",style:{"max-height":"20.3rem"}},fe=R({__name:"PlayerActionOverwrite",props:{playerId:{}},setup(T){const V=T,C=Q(),{data:c,refresh:j}=q(X(V.playerId)),i=s(""),n=s(),l=s(),b=s(!1),h=s(),o=s(),g=s(),v=J(()=>{const t=i.value!==""||n.value;return!t||t&&!o.value&&!l.value?null:!!(l.value&&b.value)});function D(t){i.value=t,A(t)}function F(t){n.value=t,A(t)}function S(){i.value="",n.value=void 0,l.value=void 0,b.value=!1,o.value=void 0}async function A(t){if(o.value=void 0,l.value=void 0,h.value=void 0,b.value=!1,t){let e;try{e=O(t)}catch(a){o.value=new P("Calculating payload failed",a.message);return}try{g.value&&g.value.cancel("Request canceled by user interaction."),g.value=N.CancelToken.source();const a=(await C.post(`/players/${c.value.id}/validateOverwrite`,e,{cancelToken:g.value.token})).data;a.error?o.value=new P("Validation failed",a.error.message,500,void 0,[{title:"Details",content:a.error.details}]):a.data.diff===""?l.value=`No differences in player model data.
Did you paste in the correct player?`:(l.value=a.data.diff,b.value=!0)}catch(a){N.isCancel(a)||a.response&&(o.value=new P("Validaiton failed",a.response.data.error.message))}}}const{showSuccessNotification:I}=W();async function G(t){const e=O(t);await C.post(`/players/${c.value.id}/importOverwrite`,e),I("Player import succeeded."),j()}function O(t){let e;try{e=JSON.parse(t)}catch(p){throw new Error(`Could not parse archive. Got '${p.message}'.`,{cause:p})}if(typeof e!="object")throw new Error(`Entity archive must be an object. Got '${typeof e}'.`);if(Array.isArray(e))throw new Error("Entity archive must be an object. Got 'array'.");if(!("entities"in e))throw new Error("Entity archive must contain entities but none found.");if(!("player"in e.entities))throw new Error("Entity archive must contain player entities but none found.");const a=Object.keys(e.entities.player);if(a.length!==1)throw new Error(`Entity archive may only contain exactly one player entity. Got ${a.length}.`);const f=Object.keys(e.entities).filter(p=>p!=="player");f.forEach(p=>delete e.entities[p]),f.length&&(h.value=f);const B=a[0],M=c.value.id;return e.remaps={player:{}},e.remaps.player[B]=M,e}return(t,e)=>{const a=U("meta-no-seatbelts");return r(c)?(u(),E(r(ae),{key:0,"modal-title":"Overwrite Player",action:()=>G(n.value??i.value),"trigger-button-label":"Overwrite Player",variant:"danger","ok-button-label":"Overwrite Player","ok-button-disabled-tooltip":v.value?void 0:"Paste in or upload a valid player to proceed.",permission:"api.players.overwrite",onShow:S,onHidden:S,"data-testid":"action-overwrite-player"},z({default:y(()=>[e[2]||(e[2]=m("h6",{class:"tw-mb-1"},"Paste Player Data",-1)),m("p",te,[e[0]||(e[0]=d("You can copy & paste the serialized data of a compatible player here to overwrite parts of ",-1)),_(r(K),null,{default:y(()=>[d(x(r(c).model.playerName||"n/a"),1)],void 0,!0),_:1}),e[1]||(e[1]=d(".",-1))]),e[3]||(e[3]=m("p",{class:"tw-mb-4"},[d("This is an "),m("span",{class:"tw-text-danger"},"advanced development feature"),d(" and should probably never be used in production!")],-1)),_(r(Z),{class:"tw-mb-2",label:"Paste in an archive...","model-value":i.value,placeholder:n.value!=null?"File upload selected":"{'entities':{'player':...",variant:v.value!==null?v.value?"success":"danger":void 0,rows:5,disabled:!!n.value,"onUpdate:modelValue":D,"data-testid":"entity-archive-text"},null,8,["model-value","placeholder","variant","disabled"]),_(r(ee),{label:"...or upload a file...","model-value":n.value,placeholder:i.value!==""?"Manual paste selected":"Choose or drop an entity archive file",variant:v.value!==null?v.value?"success":"danger":void 0,disabled:i.value!=="","accepted-file-types":".json","onUpdate:modelValue":F,"data-testid":"entity-archive-file"},null,8,["model-value","placeholder","variant","disabled"])]),"right-panel":y(()=>[e[6]||(e[6]=m("h6",{class:"tw-mb-4"},"Preview Incoming Data",-1)),h.value?(u(),E(r($),{key:0,class:"tw-mb-2",title:"Extra Entity Types",variant:"warning"},{default:y(()=>[m("p",null,[e[4]||(e[4]=d("Archive contained the following extra entity types that were removed: ",-1)),(u(!0),k(H,null,L(h.value,f=>(u(),k("span",re,x(f),1))),256))])],void 0,!0),_:1})):w("",!0),!l.value&&!o.value?(u(),E(r($),{key:1,class:"tw-mb-2",title:"Preview",variant:"neutral"},{default:y(()=>[...e[5]||(e[5]=[d("Paste in a valid player from a compatible game version to preview what data will be copied over.",-1)])],void 0,!0),_:1})):w("",!0),o.value?(u(),E(r(Y),{key:2,class:"tw-mb-2",error:o.value},null,8,["error"])):w("",!0),l.value?(u(),k("pre",le,x(l.value),1)):w("",!0)]),_:2},[v.value?{name:"bottom-panel",fn:y(()=>[_(a,{class:"tw-mx-auto tw-w-7/12",name:r(c).model.playerName||"n/a"},null,8,["name"])]),key:"0"}:void 0]),1032,["action","ok-button-disabled-tooltip"])):w("",!0)}}});export{fe as default};
