import{d as Te,by as Oe,af as Ce,c as T,h as I,i as ee,D as l,co as Me,K as te,a as x,o as b,j as p,m as W,e as Ve,q as O,w as V,t as R,f as s,k as U,z as g}from"./index-jY1EWd09.js";import{a as _,r as S,t as We}from"./MetricCard.vue_vue_type_script_setup_true_lang-BKnfkWX-.js";import{_ as ae}from"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-CqJL3vnO.js";import{M as oe}from"./MInputSingleSelectRadio-BM2VfYc3.js";import{_ as Ue}from"./MInputDuration.vue_vue_type_script_setup_true_lang-Cl7Z5XKO.js";import{_ as ie,M as _e}from"./MInputDateTime.vue_vue_type_script_setup_true_lang-BJgw3K8v.js";import{_ as k}from"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CYiRxbPX.js";import{_ as ke}from"./MInputSingleSelectSwitch.vue_vue_type_script_setup_true_lang-DPh05re_.js";const je={class:"tw-rounded-md tw-border tw-border-neutral-200 tw-bg-neutral-50 tw-p-3"},ze={class:"tw-font-semibold"},Be={key:0,class:"tw-text-xs"},Ne={key:1,class:"tw-text-xs"},$e={key:0},Re={class:"tw-mt-2 tw-flex tw-justify-between"},Je={key:1,class:"tw-mt-2 tw-flex tw-justify-between"},Ee={class:"tw-mt-2 tw-flex tw-justify-between"},Ae={key:3,class:"tw-mt-4"},He={class:"tw-flex tw-items-center tw-justify-between"},Qe={key:0},Fe={key:1},Le={key:2},at=Te({__name:"MetricsControls",props:{metricId:{},metricsInfoData:{},metricData:{}},emits:["update:resolution","update:startTime","update:endTime","update:selectedCohort","update:cohortDate","update:timeWindowMode","update:timePreset"],setup(j,{expose:ue,emit:le}){const a=Oe(),A=Ce(),w=j,m=le,H=T(()=>[{label:"Last 4 hours",value:"4h",disabled:_(w.metricId,w.metricsInfoData)?.dashboardInfo?.dailyOnly},{label:"Last 3 days",value:"3d",disabled:_(w.metricId,w.metricsInfoData)?.dashboardInfo?.dailyOnly},{label:"Last 60 days",value:"60d"},{label:"Custom",value:"custom"}]),Q={"4h":"Minutely","3d":"Hourly","60d":"Daily",custom:void 0},F=[{label:"By Date",value:"ByDate"},{label:"By Cohort",value:"ByCohort"},{label:"Averages",value:"Averages"}],re=T(()=>{const e=Q[d.value];return Object.keys(S).map(t=>{const u=S[t];let h;return e?h=Q[d.value]!==t:w.metricData?.dashboardInfo?.dailyOnly?h=t!=="Daily":h=o.value.toSeconds()-i.value.toSeconds()>u.maxWindowSizeSeconds,{label:u.label,value:t,disabled:h}})}),ne=T(()=>d.value==="custom"?"Some resolutions may be unavailable depending on the selected time range.":"Resolution is fixed for the selected time range.");async function se(e){if(!e)throw new Error("Start time cannot be undefined.");o.value.toSeconds()-e.toSeconds()>S.Daily.maxWindowSizeSeconds?i.value=l.fromSeconds(o.value.toSeconds()-S.Daily.maxWindowSizeSeconds):i.value=e,i.value=l.max(i.value,c.value),i.value=l.min(o.value.minus({minutes:1}),i.value),z(),await D(v.value,d.value,r.value,i.value,o.value)}async function de(e){if(!e)throw new Error("End time cannot be undefined.");e?.toSeconds()-i.value.toSeconds()>S.Daily.maxWindowSizeSeconds?o.value=l.fromSeconds(i.value.toSeconds()+S.Daily.maxWindowSizeSeconds):o.value=e,o.value=l.max(o.value,c.value),o.value=l.max(o.value,i.value.plus({minutes:1})),z(),await D(v.value,d.value,r.value,i.value,o.value)}async function ve(e){r.value=e,z(),await D(v.value,d.value,e,i.value,o.value)}function z(){if(w.metricData?.dashboardInfo?.dailyOnly){r.value="Daily";return}o.value.toSeconds()-i.value.toSeconds()>S[r.value].maxWindowSizeSeconds&&(r.value==="Minutely"&&o.value.toSeconds()-i.value.toSeconds()<S.Hourly.maxWindowSizeSeconds?r.value="Hourly":r.value="Daily")}async function me(e){const t=l.utc();switch(e){case"4h":i.value=l.max(l.fromSeconds(t.toSeconds()-4*3600),c.value),o.value=t,r.value="Minutely",f.value=g.fromObject({hours:4});break;case"3d":i.value=l.max(l.fromSeconds(t.toSeconds()-3*86400),c.value),o.value=t,r.value="Hourly",f.value=g.fromObject({days:3});break;case"60d":i.value=l.max(l.fromSeconds(t.toSeconds()-60*86400),c.value),o.value=t,r.value="Daily",f.value=g.fromObject({days:60});break}d.value=e,await D(v.value,e,r.value,i.value,o.value)}async function L(e){y.value=e,e!==void 0&&await P("ByCohort"),await D(v.value,d.value,r.value,i.value,o.value,f.value,q.value,y.value,n.value)}ue({selectCohort:L});async function ce(e){if(!e)return;const t=g.fromObject({days:Math.round(e.days),hours:Math.round(e.hours),minutes:Math.round(e.minutes)});f.value=t,o.value=l.utc(),i.value=l.max(o.value.minus(t),c.value),z(),await D(v.value,d.value,r.value,i.value,o.value,f.value)}ee(()=>{const e=setInterval(()=>{v.value==="liveUpdate"&&(o.value=l.utc(),i.value=l.max(o.value.minus(f.value),c.value))},1e4);Me(()=>{clearInterval(e)})});async function fe(e){v.value=e,e==="fixedWindow"?d.value="custom":(d.value=Y(),f.value=Z(),o.value=l.utc(),i.value=l.max(o.value.minus(f.value),c.value)),await D(e,d.value,r.value,i.value,o.value,f.value)}const J=T(()=>{if(!w.metricId)return[];const e=_(w.metricId,w.metricsInfoData);if(!e)return[];if(!e?.dashboardInfo?.isDailyCohorts)return[];const t=w.metricData;if(!t)return[];if(t.cohorts===void 0)return[];const u=Object.keys(t.cohorts)[0];return u?t.cohorts[u]?Object.keys(t.cohorts[u]).map(C=>({label:"D"+C,value:parseInt(C,10)})):[]:[]});async function ye(e){n.value=e,await D(v.value,d.value,r.value,i.value,o.value,f.value,q.value,y.value,n.value)}async function P(e){const t=e;if(t!==q.value){if(q.value=t,t==="Averages")y.value=void 0,n.value=void 0;else if(t==="ByDate"){if(n.value===void 0&&(n.value=i.value.toISODate()??c.value.toISODate()??void 0,!n.value)){console.error("Cohort date is undefined.");return}y.value=void 0}else t==="ByCohort"&&(n.value=void 0,y.value===void 0&&J.value[0]&&(y.value=J.value[0].value));await D(v.value,d.value,r.value,i.value,o.value,f.value,q.value,y.value,n.value)}}function we(){if(a.query.timeWindowMode){if(a.query.timeWindowMode==="liveUpdate"||a.query.timeWindowMode==="fixedWindow")return a.query.timeWindowMode;console.warn(`Invalid timeWindowMode query parameter: ${JSON.stringify(a.query.timeWindowMode)}.`)}return"liveUpdate"}const K=T(()=>{if(a.query.resolution){if(typeof a.query.resolution=="string"){const e=a.query.resolution;if(Object.keys(S).includes(e))return e}console.warn(`Invalid route query resolution parameter: ${JSON.stringify(a.query.resolution)}.`)}});function pe(){return K.value?K.value:"Daily"}const E=T(()=>{if(a.query.timeWindowMode==="fixedWindow")return"custom";if(a.query.preset){if(typeof a.query.preset=="string"){const e=a.query.preset;if(H.value.map(t=>t.value).includes(e))return e}console.warn(`Invalid route query time preset parameter: ${JSON.stringify(a.query.preset)}.`)}});function Y(){return E.value?E.value:"60d"}async function D(e,t,u,h,C,M=f.value,B=void 0,N=void 0,$=void 0){e==="liveUpdate"?await A.replace({path:a.path,query:{...a.query,timeWindowMode:e,preset:t,resolution:u,start:void 0,end:void 0,duration:M.shiftTo("days","hours","minutes").toISO(),cohortViewType:B,selectedCohort:N?.toString(),cohortDate:$}}):await A.replace({path:a.path,query:{...a.query,timeWindowMode:e,preset:t,resolution:u,start:h.toUTC().toISO(),end:C.toUTC().toISO(),duration:void 0,cohortViewType:B,selectedCohort:N?.toString(),cohortDate:$}})}ee(async()=>{E.value||await D(v.value,d.value,r.value,i.value,o.value,f.value,q.value,y.value,n.value),m("update:timeWindowMode",v.value),m("update:resolution",r.value),m("update:startTime",i.value),m("update:endTime",o.value),m("update:selectedCohort",y.value),m("update:cohortDate",n.value),m("update:timePreset",d.value)});const G=T(()=>{if(a.query.start){if(typeof a.query.start=="string"){const e=l.fromISO(a.query.start);if(e.isValid)return e}console.warn(`Invalid route query start parameter: ${JSON.stringify(a.query.start)}.`)}}),X=T(()=>{if(a.query.end){if(typeof a.query.end=="string"){const e=l.fromISO(a.query.end);if(e.isValid)return e}console.warn(`Invalid route query end parameter: ${JSON.stringify(a.query.end)}.`)}});function he(){return a.query.timeWindowMode==="liveUpdate"&&a.query.duration?l.utc().minus(g.fromISO(a.query.duration)):G.value?G.value:l.utc().minus(S[r.value].windowSizeSeconds*1e3)}function Se(){return a.query.timeWindowMode==="liveUpdate"&&a.query.duration?l.utc().toUTC():X.value?X.value:l.utc()}function Z(){if(a.query.preset==="custom"&&a.query.duration){let e=g.fromISO(a.query.duration,{conversionAccuracy:"longterm"});if(e.isValid)return e=e.shiftTo("days","hours","minutes").normalize(),e;console.warn(`Invalid duration query parameter: ${JSON.stringify(a.query.duration)}.`)}if(o.value&&i.value){let e=g.fromMillis(o.value.toMillis()-i.value.toMillis());return e=g.fromObject({minutes:Math.round(e.as("minutes"))}),e=e.shiftTo("days","hours","minutes").normalize(),e}else return g.fromObject({hours:4})}function De(){if(a.query.cohortViewType==="ByCohort"&&a.query.selectedCohort){if(typeof a.query.selectedCohort=="string"){const e=parseInt(a.query.selectedCohort,10);if(!isNaN(e))return e}console.warn(`Invalid selectedCohort query parameter: ${JSON.stringify(a.query.selectedCohort)}.`)}}function Ie(){if(a.query.cohortViewType){if(typeof a.query.cohortViewType=="string"){const e=a.query.cohortViewType;if(F.map(t=>t.value).includes(e))return e}console.warn(`Invalid cohortViewType query parameter: ${JSON.stringify(a.query.cohortViewType)}.`)}if(_(w.metricId,w.metricsInfoData)?.dashboardInfo?.isDailyCohorts)return"Averages"}function be(){if(a.query.cohortViewType==="ByDate"&&a.query.cohortDate){if(typeof a.query.cohortDate=="string"){const e=a.query.cohortDate;if(l.fromISO(e).isValid)return e}console.warn(`Invalid cohortDate query parameter: ${JSON.stringify(a.query.cohortDate)}.`)}}const c=I(l.fromSeconds(0)),d=I(Y()),r=I(pe()),o=I(Se()),i=I(he()),v=I(we()),f=I(Z()),y=I(De()),q=I(Ie()),n=I(be());return te([v,r,i,o,y,n],([e,t,u,h,C,M],[B,N,$,qe,xe,ge])=>{e!==B&&m("update:timeWindowMode",e),t!==N&&m("update:resolution",t),u!==$&&(m("update:startTime",u),n.value&&n.value<(u.toISODate()??"")&&(n.value=u.toISODate()??"",m("update:cohortDate",M))),h!==qe&&(m("update:endTime",h),n.value&&n.value>(h.toISODate()??"")&&(n.value=h.toISODate()??"",m("update:cohortDate",M))),C!==xe&&m("update:selectedCohort",C),M!==ge&&m("update:cohortDate",M)}),te(()=>w.metricsInfoData,e=>{e&&(c.value=l.fromISO(e.epochTime),i.value=l.max(c.value,i.value),o.value=l.max(c.value,o.value))},{immediate:!0}),(e,t)=>(b(),x("div",je,[p(s(ae),{options:s(We),label:"Time Window","model-value":v.value,"onUpdate:modelValue":fe,"data-testid":"metrics-time-window-dropdown"},{option:V(({option:u})=>[O("div",ze,R(u.label),1),u.value==="liveUpdate"?(b(),x("div",Be,"Show live data that updates every 10 seconds. You can change the duration to control how much data is shown.")):u.value==="fixedWindow"?(b(),x("div",Ne,"Show data from a fixed time window. You can change the start and end times to view a different time window.")):W("",!0)]),_:1},8,["options","model-value"]),v.value==="liveUpdate"?(b(),x("div",$e,[O("div",Re,[t[8]||(t[8]=O("div",{class:"tw-block tw-text-sm tw-font-bold"},"Duration",-1)),p(s(oe),{"model-value":d.value,options:H.value,size:"small","onUpdate:modelValue":t[0]||(t[0]=u=>me(u))},null,8,["model-value","options"])]),p(s(Ue),{class:"tw-mt-2","model-value":f.value,disabled:d.value!=="custom","max-duration":s(S)[r.value].maxWindowSizeSeconds,"onUpdate:modelValue":t[1]||(t[1]=u=>ce(u))},null,8,["model-value","disabled","max-duration"])])):W("",!0),v.value==="fixedWindow"?(b(),x("div",Je,[p(s(ie),{"model-value":i.value,label:"Start Time (UTC)","max-date-time":o.value,"min-date-time":c.value,"onUpdate:modelValue":t[2]||(t[2]=u=>se(u))},null,8,["model-value","max-date-time","min-date-time"]),p(s(ie),{"model-value":o.value,label:"End Time (UTC)","max-date-time":s(l).now(),"min-date-time":s(l).max(c.value,i.value.plus({minutes:1})),"onUpdate:modelValue":t[3]||(t[3]=u=>de(u))},null,8,["model-value","max-date-time","min-date-time"])])):W("",!0),c.value===i.value?(b(),Ve(s(k),{key:2,variant:"warning"},{default:V(()=>[...t[9]||(t[9]=[U("Start time has been adjusted to the epoch time of the metrics data.",-1)])],void 0,!0),_:1})):W("",!0),O("div",Ee,[t[10]||(t[10]=O("div",{class:"tw-text-sm tw-font-bold"},"Resolution",-1)),p(s(oe),{"model-value":r.value,options:re.value,size:"small","onUpdate:modelValue":t[4]||(t[4]=u=>ve(u))},null,8,["model-value","options"])]),p(s(k),null,{default:V(()=>[U(R(ne.value),1)],void 0,!0),_:1}),j.metricId&&s(_)(j.metricId,j.metricsInfoData)?.dashboardInfo?.isDailyCohorts?(b(),x("div",Ae,[t[13]||(t[13]=O("div",{class:"tw-mb-2 tw-border-b tw-border-neutral-200"},null,-1)),O("div",He,[t[11]||(t[11]=O("p",{class:"tw-text-sm tw-font-bold"},"Daily Cohort View",-1)),p(s(ke),{"model-value":q.value??"Averages",options:F,"onUpdate:modelValue":t[5]||(t[5]=u=>P(u))},null,8,["model-value"])]),q.value==="ByDate"?(b(),x("div",Qe,[p(s(_e),{"model-value":n.value??i.value.toISODate()??"","max-iso-date":o.value.toISODate()??"","min-iso-date":i.value.toISODate()??"",label:"Cohort Start Date",size:"small","onUpdate:modelValue":t[6]||(t[6]=u=>ye(u))},null,8,["model-value","max-iso-date","min-iso-date"]),p(s(k),{class:"tw-mt-3"},{default:V(()=>[U("Showing cohort data starting from "+R(n.value??"")+".",1)],void 0,!0),_:1})])):q.value==="ByCohort"?(b(),x("div",Fe,[p(s(ae),{"model-value":y.value,options:J.value,label:"Selected Cohort",size:"small","onUpdate:modelValue":t[7]||(t[7]=u=>L(u))},null,8,["model-value","options"]),p(s(k),{class:"tw-mt-3"},{default:V(()=>[U("Showing cohort data for "+R(y.value!==void 0?"D"+y.value:"")+".",1)],void 0,!0),_:1})])):(b(),x("div",Le,[p(s(k),null,{default:V(()=>[...t[12]||(t[12]=[U("Showing averages of daily cohorts.",-1)])],void 0,!0),_:1})]))])):W("",!0)]))}});export{at as _};
