import{d as x,a as y,o as p,q as B,j as d,E as O,c as $,h as S,K as N,r as h,e as k,f as w,af as U,z as A,D as g,I as F,w as C,m as P,bs as E,bt as M}from"./index-jY1EWd09.js";import{_}from"./MetaGeneratedForm.vue_vue_type_script_setup_true_lang-C4tXbiPC.js";import{_ as V}from"./PlayerSegmentsInput.vue_vue_type_script_setup_true_lang-0j5ld439.js";import{g as j}from"./analyticsEvents-CULxlf4Q.js";import{_ as z}from"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-CqJL3vnO.js";import{_ as q}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CTycXHot.js";import{_ as R}from"./MInputText.vue_vue_type_script_setup_true_lang-Wwv8TYAB.js";import{_ as G}from"./MInputDateTime.vue_vue_type_script_setup_true_lang-BJgw3K8v.js";import{_ as K}from"./MInputDurationOrEndDateTime.vue_vue_type_script_setup_true_lang-CKRXnU8E.js";const L={class:"tw-relative tw-z-10 tw-@container"},H={class:"tw-w-full tw-space-y-4 @[700px]:tw-flex @[700px]:tw-space-x-4 @[700px]:tw-space-y-0"},J=x({__name:"MInputStartDateTimeAndDuration",props:{startDateTime:{},duration:{},disabled:{type:Boolean}},emits:["update:startDateTime","update:duration"],setup(a,{emit:f}){const e=f;function m(r){if(!r)throw new Error("Invalid start date time",{cause:r});e("update:startDateTime",r)}return(r,s)=>(p(),y("div",L,[B("div",H,[d(G,{class:"tw-flex-shrink-0","model-value":a.startDateTime,label:"Start (UTC)",disabled:a.disabled,"onUpdate:modelValue":s[0]||(s[0]=t=>m(t))},null,8,["model-value","disabled"]),d(K,{class:"tw-grow","model-value":a.duration,referenceDateTime:a.startDateTime,disabled:a.disabled,"onUpdate:modelValue":s[1]||(s[1]=t=>r.$emit("update:duration",t))},null,8,["model-value","referenceDateTime","disabled"])])]))}}),Q={key:0,class:"tw-w-full tw-text-center"},W={key:1,class:"text-muted text-small tw-w-full tw-text-center tw-italic"},X=x({__name:"TriggerConditionForm",props:{modelValue:{}},emits:["update:modelValue"],setup(a,{emit:f}){const e=a,m=f,{data:r}=O(j()),s=i=>r.value?.find(l=>l.typeCode===i)?.displayName??i.toString(),t=$(()=>{if(!r.value)return[];const u=r.value.filter(l=>l.categoryName==="Player"&&l.canTrigger).map(l=>({label:`${l.typeCode.toString()}: ${s(l.typeCode)}`,value:l.typeCode}));return u.push({clearedValue:void 0}),u}),c=S();return N(()=>e.modelValue,i=>{c.value=i?.eventTypeCode},{immediate:!0}),N(c,i=>{i?m("update:modelValue",{$type:"Metaplay.Server.PlayerTriggerConditionByTriggerType",eventTypeCode:i}):m("update:modelValue",void 0)}),(i,u)=>{const l=h("b-spinner");return t.value?t.value.length===0?(p(),y("div",W,"No trigger events defined!")):(p(),k(w(z),{key:2,modelValue:c.value,options:t.value,placeholder:"No trigger condition","onUpdate:modelValue":u[0]||(u[0]=D=>c.value=D)},null,8,["modelValue","options"])):(p(),y("div",Q,[d(l,{label:"Loading trigger events..."})]))}}}),Y={key:0,class:"tw-mb-4"},Z={class:"tw-@container"},dt=x({__name:"BroadcastFormButton",props:{buttonText:{},buttonIcon:{default:void 0},prefillData:{default:void 0},editBroadcast:{type:Boolean},broadcastType:{default:"Metaplay.Server.BroadcastMessageContents"},itemName:{default:"Broadcast"},triggeringSupported:{type:Boolean},disabledTooltip:{default:void 0},dataTestid:{default:void 0}},emits:["refresh"],setup(a,{emit:f}){const e=a,m=E(),r=U(),s=f,t=S(c());function c(){return{name:"",audience:V.props?.modelValue.default(),startAt:g.utc().startOf("minute"),duration:A.fromObject({days:1}),contents:{},triggerCondition:void 0}}const i=$(()=>!(!t.value.name||t.value.name.length===0)),u=$(()=>{if(!i.value&&!b.value)return"Fill in the required fields to proceed.";if(!i.value)return"Fill in a valid name to proceed.";if(t.value.duration.toMillis()===0)return"The broadcast duration is invalid. Check that it is set correctly to proceed.";if(!t.value.audience.valid)return"The audience targeting is missing or invalid. Check that it is filled out correctly to proceed.";if(!b.value)return"Fill in the broadcast message for all selected locales to proceed."}),{showSuccessNotification:l}=M();async function D(){const v={name:t.value.name,startAt:t.value.startAt.toISO(),endAt:t.value.startAt.plus(t.value.duration).toISO(),targetPlayers:t.value.audience.targetPlayers,targetCondition:t.value.audience.targetCondition,contents:t.value.contents,triggerCondition:t.value.triggerCondition};if(e.prefillData&&e.editBroadcast){v.id=e.prefillData.id,await m.put(`/broadcasts/${v.id}`,v);const o=`${e.itemName} with id ${e.prefillData.id} updated.`;l(o),s("refresh")}else{const o=(await m.post("/broadcasts",v)).data,T=`New ${e.itemName} created with id ${o.id}.`;l(T),s("refresh"),e.prefillData&&await r.push("/broadcasts")}}const b=S(!1);function I(){e.prefillData?(t.value.name=e.editBroadcast?e.prefillData.name:e.prefillData.name+" (copy)",t.value.audience.targetPlayers=e.prefillData.targetPlayers,t.value.audience.targetCondition=e.prefillData.targetCondition,t.value.startAt=e.editBroadcast&&e.prefillData.startAt!==null?g.fromISO(e.prefillData.startAt):g.utc(),t.value.duration=e.editBroadcast&&e.prefillData.endAt&&e.prefillData.startAt!==null?g.fromISO(e.prefillData.endAt).diff(g.fromISO(e.prefillData.startAt),["days","minutes","hours"]):A.fromObject({days:1}),t.value.contents=e.prefillData.contents,t.value.triggerCondition=e.prefillData.triggerCondition,b.value=!0):t.value=c()}return(v,o)=>{const T=h("fa-icon");return p(),k(w(q),{"modal-title":`${a.buttonText} ${a.itemName}`,action:D,"trigger-button-label":a.buttonText,"trigger-button-disabled-tooltip":a.disabledTooltip,"ok-button-label":a.editBroadcast?"Update Broadcast":"Start Broadcast","action-button-text":a.buttonText,"ok-button-disabled-tooltip":u.value,permission:"api.broadcasts.edit",onShow:I,"data-testid":a.dataTestid},F({"right-panel":C(()=>[B("div",Z,[d(_,{class:"tw-relative tw-z-0",typeName:a.broadcastType,"is-targeting-multiple-players":"",value:t.value.contents,page:"BroadcastForm",onInput:o[5]||(o[5]=n=>t.value.contents=n),onStatus:o[6]||(o[6]=n=>b.value=n)},null,8,["typeName","value"])])]),default:C(()=>[d(w(R),{class:"tw-mb-4",label:"Name","model-value":t.value.name,variant:i.value?"success":"danger",placeholder:`${a.itemName} name here...`,"onUpdate:modelValue":o[0]||(o[0]=n=>t.value.name=n),"data-testid":"broadcast-name"},null,8,["model-value","variant","placeholder"]),d(w(J),{class:"tw-mb-4",startDateTime:t.value.startAt,duration:t.value.duration,"onUpdate:startDateTime":o[1]||(o[1]=n=>t.value.startAt=n),"onUpdate:duration":o[2]||(o[2]=n=>t.value.duration=n)},null,8,["startDateTime","duration"]),d(V,{class:"tw-mb-4","model-value":t.value.audience,"onUpdate:modelValue":o[3]||(o[3]=n=>t.value.audience=n)},null,8,["model-value"]),a.triggeringSupported?(p(),y("div",Y,[o[7]||(o[7]=B("div",{class:"tw-text-sm tw-font-bold tw-leading-6"},"Triggering",-1)),d(X,{"model-value":t.value.triggerCondition,"onUpdate:modelValue":o[4]||(o[4]=n=>t.value.triggerCondition=n)},null,8,["model-value"])])):P("",!0)],void 0,!0),_:2},[a.buttonIcon?{name:"trigger-button-icon",fn:C(()=>[d(T,{class:"tw-mb-[0.05rem] tw-h-3.5 tw-w-4 tw-space-x-2",icon:a.buttonIcon},null,8,["icon"])]),key:"0"}:void 0]),1032,["modal-title","trigger-button-label","trigger-button-disabled-tooltip","ok-button-label","action-button-text","ok-button-disabled-tooltip","data-testid"])}}});export{dt as _};
