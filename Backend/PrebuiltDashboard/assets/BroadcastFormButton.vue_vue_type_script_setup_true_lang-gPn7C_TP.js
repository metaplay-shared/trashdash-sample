import{d as _,a as y,o as c,q as B,j as u,E as U,c as $,h as S,K as A,r as I,e as N,f as w,af as F,z as V,D as v,w as C,m as h,bs as P,bt as x}from"./index-B-VT6L6o.js";import{_ as E}from"./MetaGeneratedForm.vue_vue_type_script_setup_true_lang-DQCVqnhW.js";import{_ as k}from"./PlayerSegmentsInput.vue_vue_type_script_setup_true_lang-CPg3Ztz0.js";import{g as M}from"./analyticsEvents-B4g3w6s0.js";import{_ as j}from"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-Dv81Anyh.js";import{_ as z}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CzHe6hW1.js";import{_ as q}from"./MInputText.vue_vue_type_script_setup_true_lang-Dfga_g5u.js";import{_ as R}from"./MInputDateTime.vue_vue_type_script_setup_true_lang-C6JS_loc.js";import{_ as G}from"./MInputDurationOrEndDateTime.vue_vue_type_script_setup_true_lang-Bm9sy_C1.js";const K={class:"tw-relative tw-z-10 tw-@container"},L={class:"tw-w-full tw-space-y-4 @[700px]:tw-flex @[700px]:tw-space-x-4 @[700px]:tw-space-y-0"},H=_({__name:"MInputStartDateTimeAndDuration",props:{startDateTime:{},duration:{},disabled:{type:Boolean}},emits:["update:startDateTime","update:duration"],setup(g,{emit:f}){const t=f;function m(i){if(!i)throw new Error("Invalid start date time",{cause:i});t("update:startDateTime",i)}return(i,s)=>(c(),y("div",K,[B("div",L,[u(R,{class:"tw-flex-shrink-0","model-value":i.startDateTime,label:"Start (UTC)",disabled:i.disabled,"onUpdate:modelValue":s[0]||(s[0]=e=>m(e))},null,8,["model-value","disabled"]),u(G,{class:"tw-grow","model-value":i.duration,referenceDateTime:i.startDateTime,disabled:i.disabled,"onUpdate:modelValue":s[1]||(s[1]=e=>i.$emit("update:duration",e))},null,8,["model-value","referenceDateTime","disabled"])])]))}}),J={key:0,class:"tw-w-full tw-text-center"},Q={key:1,class:"text-muted text-small tw-w-full tw-text-center tw-italic"},W=_({__name:"TriggerConditionForm",props:{modelValue:{}},emits:["update:modelValue"],setup(g,{emit:f}){const t=g,m=f,{data:i}=U(M()),s=r=>i.value?.find(l=>l.typeCode===r)?.displayName??r.toString(),e=$(()=>{if(!i.value)return[];const d=i.value.filter(l=>l.categoryName==="Player"&&l.canTrigger).map(l=>({label:`${l.typeCode.toString()}: ${s(l.typeCode)}`,value:l.typeCode}));return d.push({clearedValue:void 0}),d}),p=S();return A(()=>t.modelValue,r=>{p.value=r?.eventTypeCode},{immediate:!0}),A(p,r=>{r?m("update:modelValue",{$type:"Metaplay.Server.PlayerTriggerConditionByTriggerType",eventTypeCode:r}):m("update:modelValue",void 0)}),(r,d)=>{const l=I("b-spinner");return e.value?e.value.length===0?(c(),y("div",Q,"No trigger events defined!")):(c(),N(w(j),{key:2,modelValue:p.value,options:e.value,placeholder:"No trigger condition","onUpdate:modelValue":d[0]||(d[0]=D=>p.value=D)},null,8,["modelValue","options"])):(c(),y("div",J,[u(l,{label:"Loading trigger events..."})]))}}}),X={key:0,class:"tw-mb-4"},Y={class:"tw-@container"},se=_({__name:"BroadcastFormButton",props:{buttonText:{},buttonIcon:{default:void 0},prefillData:{default:void 0},editBroadcast:{type:Boolean},broadcastType:{default:"Metaplay.Server.BroadcastMessageContents"},itemName:{default:"Broadcast"},triggeringSupported:{type:Boolean},disabledTooltip:{default:void 0},dataTestid:{default:void 0}},emits:["refresh"],setup(g,{emit:f}){const t=g,m=P(),i=F(),s=f,e=S(p());function p(){return{name:"",audience:k.props?.modelValue.default(),startAt:v.utc().startOf("minute"),duration:V.fromObject({days:1}),contents:{},triggerCondition:void 0}}const r=$(()=>!(!e.value.name||e.value.name.length===0)),d=$(()=>{if(!r.value&&!b.value)return"Fill in the required fields to proceed.";if(!r.value)return"Fill in a valid name to proceed.";if(e.value.duration.toMillis()===0)return"The broadcast duration is invalid. Check that it is set correctly to proceed.";if(!e.value.audience.valid)return"The audience targeting is missing or invalid. Check that it is filled out correctly to proceed.";if(!b.value)return"Fill in the broadcast message for all selected locales to proceed."}),{showSuccessNotification:l}=x();async function D(){const o={name:e.value.name,startAt:e.value.startAt.toISO(),endAt:e.value.startAt.plus(e.value.duration).toISO(),targetPlayers:e.value.audience.targetPlayers,targetCondition:e.value.audience.targetCondition,contents:e.value.contents,triggerCondition:e.value.triggerCondition};if(t.prefillData&&t.editBroadcast){o.id=t.prefillData.id,await m.put(`/broadcasts/${o.id}`,o);const a=`${t.itemName} with id ${t.prefillData.id} updated.`;l(a),s("refresh")}else{const a=(await m.post("/broadcasts",o)).data,T=`New ${t.itemName} created with id ${a.id}.`;l(T),s("refresh"),t.prefillData&&await i.push("/broadcasts")}}const b=S(!1);function O(){t.prefillData?(e.value.name=t.editBroadcast?t.prefillData.name:t.prefillData.name+" (copy)",e.value.audience.targetPlayers=t.prefillData.targetPlayers,e.value.audience.targetCondition=t.prefillData.targetCondition,e.value.startAt=t.editBroadcast&&t.prefillData.startAt!==null?v.fromISO(t.prefillData.startAt):v.utc(),e.value.duration=t.editBroadcast&&t.prefillData.endAt&&t.prefillData.startAt!==null?v.fromISO(t.prefillData.endAt).diff(v.fromISO(t.prefillData.startAt),["days","minutes","hours"]):V.fromObject({days:1}),e.value.contents=t.prefillData.contents,e.value.triggerCondition=t.prefillData.triggerCondition,b.value=!0):e.value=p()}return(o,a)=>{const T=I("fa-icon");return c(),N(w(z),{"modal-title":`${o.buttonText} ${o.itemName}`,action:D,"trigger-button-label":o.buttonText,"trigger-button-disabled-tooltip":o.disabledTooltip,"ok-button-label":o.editBroadcast?"Update Broadcast":"Start Broadcast","action-button-text":o.buttonText,"ok-button-disabled-tooltip":d.value,permission:"api.broadcasts.edit",onShow:O,"data-testid":o.dataTestid},{"trigger-button-icon":C(()=>[o.buttonIcon?(c(),N(T,{key:0,class:"tw-mb-[0.05rem] tw-h-3.5 tw-w-4 tw-space-x-2",icon:o.buttonIcon},null,8,["icon"])):h("",!0)]),"right-panel":C(()=>[B("div",Y,[u(E,{class:"tw-relative tw-z-0",typeName:o.broadcastType,"is-targeting-multiple-players":"",value:e.value.contents,page:"BroadcastForm",onInput:a[5]||(a[5]=n=>e.value.contents=n),onStatus:a[6]||(a[6]=n=>b.value=n)},null,8,["typeName","value"])])]),default:C(()=>[u(w(q),{class:"tw-mb-4",label:"Name","model-value":e.value.name,variant:r.value?"success":"danger",placeholder:`${o.itemName} name here...`,"onUpdate:modelValue":a[0]||(a[0]=n=>e.value.name=n),"data-testid":"broadcast-name"},null,8,["model-value","variant","placeholder"]),u(w(H),{class:"tw-mb-4",startDateTime:e.value.startAt,duration:e.value.duration,"onUpdate:startDateTime":a[1]||(a[1]=n=>e.value.startAt=n),"onUpdate:duration":a[2]||(a[2]=n=>e.value.duration=n)},null,8,["startDateTime","duration"]),u(k,{class:"tw-mb-4","model-value":e.value.audience,"onUpdate:modelValue":a[3]||(a[3]=n=>e.value.audience=n)},null,8,["model-value"]),o.triggeringSupported?(c(),y("div",X,[a[7]||(a[7]=B("div",{class:"tw-text-sm tw-font-bold tw-leading-6"},"Triggering",-1)),u(W,{"model-value":e.value.triggerCondition,"onUpdate:modelValue":a[4]||(a[4]=n=>e.value.triggerCondition=n)},null,8,["model-value"])])):h("",!0)],void 0,!0),_:1},8,["modal-title","trigger-button-label","trigger-button-disabled-tooltip","ok-button-label","action-button-text","ok-button-disabled-tooltip","data-testid"])}}});export{se as _};
