import{d as G,E as x,aa as I,r as L,e as S,m as T,f as r,o as l,w as o,j as a,k as n,t as h,q as u,a as p,_ as A,b as U,ae as N,F as q,x as V,ah as B,ab as O,ac as R,c as E,dQ as F,bl as H,T as W,y as $,D as k,B as j,A as J,bJ as Q}from"./index-jY1EWd09.js";import{E as z,M as K}from"./MetaEventStreamCard-BR93ljz-.js";import{C as P}from"./CoreUiPlacement-BNT2Q2Hu.js";import X from"./MetaListCard-1ZrdC8ii.js";import{_ as Y}from"./MTwoColumnLayout.vue_vue_type_script_setup_true_lang-B5zJm1QQ.js";import{_ as C}from"./MRawDataCard.vue_vue_type_script_setup_true_lang-Db7v8Vrj.js";import{_ as Z,a as ee}from"./MViewContainer.vue_vue_type_script_setup_true_lang-C_1W2rCL.js";import"./MInputSingleSelectSwitch.vue_vue_type_script_setup_true_lang-DPh05re_.js";import"./index-Dec9dGh3.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CYiRxbPX.js";import"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-CqJL3vnO.js";import"./MInputText.vue_vue_type_script_setup_true_lang-Wwv8TYAB.js";import"./debounce-DkFP0rfT.js";import"./isSymbol-B-tfGeoT.js";import"./MInputMultiSelectCheckbox.vue_vue_type_script_setup_true_lang-BmEacL49.js";import"./MInputCheckbox.vue_vue_type_script_setup_true_lang-Bzg4Lkt_.js";import"./metaListUtils-B-xQ0HnD.js";import"./utils-B01yCWQ7.js";import"./_baseIteratee-FGZghVLZ.js";import"./identity-DKeuBCMA.js";import"./MInputSingleSelectRadio-BM2VfYc3.js";import"./button-group-DH69WWlM.js";const re=G({__name:"TelemetryMessagesCard",setup(_){const{data:s,error:t}=x(I());function b(f){switch(f){case"Information":return"primary";case"Warning":return"warning";case"Error":return"danger";default:return"primary"}}return(f,v)=>{const w=L("fa-icon");return r(s)?(l(),S(r(X),{key:0,icon:"message",title:"Telemetry Messages",itemList:r(s)?.messages,searchFields:["category","level","title","content"],emptyMessage:"No telemetry messages. All components are up-to-date!",permission:"api.system.view_telemetry_messages","data-testid":"telemetry-messages-card"},{"item-card":o(({item:m})=>[a(r(V),null,{"top-right":o(()=>[a(r(A),{variant:b(m.level)},{default:o(()=>[n(h(m.level),1)],void 0,!0),_:2},1032,["variant"]),(l(!0),p(q,null,U(m.links,c=>(l(),p("div",null,[a(r(N),{to:c.url},{default:o(()=>[n(h(c.text),1)],void 0,!0),_:2},1032,["to"])]))),256))]),"bottom-left":o(()=>[u("span",null,h(m.body),1)]),default:o(()=>[n(h(m.title),1)],void 0,!0),_:2},1024)]),_:1},8,["itemList"])):r(t)?(l(),S(r(B),{key:1,title:"Telemetry Messages",error:r(t),"data-testid":"telemetry-messages-card"},{icon:o(()=>[a(w,{icon:"message"})]),_:1},8,["error"])):T("",!0)}}});function M(_,s,t){return{label:_,filter:s,expression:t}}function D(_,s,t,b,f){const v=[M("app","=","metaplay-server")];s&&v.push(M("namespace","=",s)),t.forEach(y=>v.push(y));const m={datasource:"Loki",queries:[{expr:`{${v.reduce((y,g)=>`${y}${y?",":""}${g.label}${g.filter}"${g.expression}"`,"")}}`}],range:{from:b,to:f}},c=JSON.stringify(m);return`${_}/explore?orgId=1&left=${c}`}const te={class:"tw-space-y-1"},ae={key:0},se={key:1},oe={key:0,class:"tw-text-xs+ tw-text-neutral-500"},ne={key:0,class:"tw-ml-1"},ie={key:1,class:"tw-ml-1"},le={class:"tw-mt-6 tw-space-y-1"},me={key:0},Ie=G({__name:"GameServerMessageCenterView",setup(_){const s=O(),{data:t,error:b}=x(R()),f=E(()=>s.environmentInfo.grafanaUri),v=E(()=>{if(s.environmentInfo.grafanaUri)return D(s.environmentInfo.grafanaUri,s.environmentInfo.kubernetesNamespace??void 0,[M("loglevel","=~","ERR|WRN")],"now-1h","now")});function w(d){if(!s.environmentInfo.grafanaUri)return;const e=new Date(d.time);return D(s.environmentInfo.grafanaUri,s.environmentInfo.kubernetesNamespace??void 0,[],new Date(+e-3e4),new Date(+e+1e3))}const m=E(()=>{if(t.value){const d=/\n.*/g;return t.value.errors.map(i=>new z(i.timestamp,i.sourceType,i.message.replace(d,""),i.id,i,"","",""))}else return[]});function c(d){const e=d.typeData.sourceData,i=new Q(e.source,e.message);return e.exception&&i.addDetail("Exception",e.exception),e.stackTrace&&i.addDetail("Stack",e.stackTrace),i}const y=E(()=>{if(t.value?.overMaxErrorCount){const d=t.value.errorCount,e=F(t.value);return[{title:"Too Many Errors",message:`The server has generated over ${d} errors ${e}. This may indicate a problem with the server.`,variant:"danger"}]}else return[]}),{data:g}=x(I());return(d,e)=>(l(),S(r(ee),{"is-loading":!r(t),permission:"api.system.view_error_logs",error:r(b),alerts:y.value},{overview:o(()=>[a(r(Z),{title:"Game Server Message Center"},{default:o(()=>[u("div",te,[e[7]||(e[7]=u("h4",null,"About Game Server Errors",-1)),e[8]||(e[8]=u("p",null,"These are the most recent errors that have been logged by the server. Errors are often indicative of a problem with the server, and should be investigated.",-1)),u("p",null,[r(t)?(l(),p("span",ae,[e[0]||(e[0]=n("The logging collector was restarted ",-1)),a(r($),{instant:r(k).fromISO(r(t).collectorRestartTime)},null,8,["instant"]),e[1]||(e[1]=n(".",-1))])):(l(),p("span",se,"Server errors not loaded..."))]),r(t)?(l(),p("p",oe,[e[5]||(e[5]=n("Errors listed on this page are only stored for ",-1)),a(r(j),{duration:r(J)(r(t).maxAge),"disable-tooltip":""},null,8,["duration"]),e[6]||(e[6]=n(" and are not retained across server restarts.",-1)),f.value?(l(),p("span",ne,[e[3]||(e[3]=n("A more complete history of errors and warnings is available in ",-1)),a(r(N),{to:v.value,permission:"dashboard.grafana.view"},{default:o(()=>[...e[2]||(e[2]=[n("Grafana",-1)])],void 0,!0),_:1},8,["to"]),e[4]||(e[4]=n(".",-1))])):(l(),p("span",ie,"When Grafana is configured, a more complete history of errors and warnings can be found there."))])):T("",!0)]),u("div",le,[e[11]||(e[11]=u("h4",null,"About Telemetry Messages",-1)),e[12]||(e[12]=u("p",null,"Telemetry messages inform you of more recent versions of components being available that are currently used by the game server.",-1)),r(g)?(l(),p("p",me,[e[9]||(e[9]=n("Telemetry messages were updated ",-1)),a(r($),{instant:r(k).fromISO(r(g).updatedAt)},null,8,["instant"]),e[10]||(e[10]=n(".",-1))])):T("",!0),e[13]||(e[13]=u("p",{class:"tw-text-xs+ tw-text-neutral-500"},"For example, when more recent versions of the Metaplay SDK, .NET runtime, or the Helm chart are published, you'll get messages about them on this page. The messages are received from the Metaplay developer portal using the server's built-in telemetry manager which reports the component versions used and gets the messages in return.",-1))])],void 0,!0),_:1})]),default:o(()=>[a(P,{placementId:"GameServerMessageCenter/List"}),a(r(Y),{class:"tw-mt-3"},{default:o(()=>[a(r(K),{icon:"bug",title:"Latest Game Server Errors","event-stream":m.value,utilitiesMode:"filter","empty-message":"No errors logged.","no-results-message":"No errors found. Try a different search.","allow-pausing":"",permission:"api.system.view_error_logs","data-testId":"game-server-errors-card"},{"event-details":o(({event:i})=>[a(r(H),{error:c(i)},{buttons:o(()=>[a(r(W),{to:w(i),"disabled-tooltip":f.value?void 0:"Grafana has not been configured for this environment.",permission:"dashboard.grafana.view"},{default:o(()=>[...e[14]||(e[14]=[n("View in Grafana",-1)])],void 0,!0),_:1},8,["to","disabled-tooltip"])]),_:2},1032,["error"])]),_:1},8,["event-stream"]),a(re)],void 0,!0),_:1}),a(r(C),{data:r(t),label:"errorCountsData"},null,8,["data"]),a(r(C),{data:r(g),label:"telemetryMessagesData"},null,8,["data"])],void 0,!0),_:1},8,["is-loading","error","alerts"]))}});export{Ie as default};
