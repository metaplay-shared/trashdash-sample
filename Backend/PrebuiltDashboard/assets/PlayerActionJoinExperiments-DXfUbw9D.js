import{d as G,E as h,h as E,c as s,r as B,e as I,o as v,w as u,a as D,f as r,a6 as F,k as o,j as p,ae as U,q as x,m as J,_ as M,t as q,bs as z,bt as R}from"./index-jY1EWd09.js";import{g as Y}from"./experiments--yH9JT0q.js";import{a as H}from"./players-Dfl1Givn.js";import{_ as k}from"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-CqJL3vnO.js";import{_ as K}from"./MInputCheckbox.vue_vue_type_script_setup_true_lang-Bzg4Lkt_.js";import{_ as L}from"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CYiRxbPX.js";import{_ as Q}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CTycXHot.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-CihjvaoM.js";import"./index-qe4CXcF2.js";const W={key:1,class:"tw-space-y-3"},X={class:"tw-pt-2"},se=G({__name:"PlayerActionJoinExperiments",props:{playerId:{}},setup(S){const T=S,y=z(),{data:n,refresh:N}=h(H(T.playerId)),{data:g}=h(Y()),e=E(b()),$=s(()=>Object.values(g.value?.experiments??[]).filter(a=>["Inactive","Testing","Ongoing","Paused"].includes(a.phase)&&a.whyInvalid===null).map(a=>({value:a.experimentId,label:Object.keys(n.value.model.experiments.experimentGroupAssignment).includes(a.experimentId)?`${a.displayName} / ${a.experimentId} (already enrolled)`:a.displayName}))),m=E([]);async function A(l){if(l===null)return;e.value.experimentId=l;const t=Object.entries(w.value).filter(([i,_])=>_.isPlayerTester);if(e.value.isTester=t.find(([i,_])=>i===e.value.experimentId)!==void 0,f.value?e.value.variantId=n.value.model.experiments.experimentGroupAssignment[e.value.experimentId]?.variantId??"Control group":e.value.variantId=null,m.value=[],!e.value.experimentId||e.value.experimentId==="none")return;const a=await y.get(`/experiments/${e.value.experimentId}`),d=Object.keys(a.data.state.variants).map(i=>({value:i,label:n.value.model.experiments.experimentGroupAssignment[e.value.experimentId]?.variantId===i?`${i} (already enrolled)`:i}));m.value=[{value:"Control group",label:"Control group"},...d]}const{showSuccessNotification:V}=R(),c=s(()=>!e.value.experimentId||!e.value.variantId?"Please select an experiment and variant.":f.value&&P.value?w.value[e.value.experimentId]?.isPlayerTester!==e.value.isTester?void 0:"No changes detected.":void 0);async function O(){const l=f.value?`${n.value.model.playerName} changed experiment variant.`:`${n.value.id} enrolled into the experiment.`,t=e.value.variantId==="Control group"?null:e.value.variantId;await y.post(`/players/${n.value.id}/changeExperiment`,{ExperimentId:e.value.experimentId,VariantId:t,IsTester:e.value.isTester}),V(l),N()}function C(){e.value=b(),m.value=[{value:"none",label:"Select an experiment"}]}function b(){return{experimentId:null,variantId:null,isTester:!1}}const j=s(()=>(g.value?.experiments??[]).length>0),w=s(()=>n.value.experiments),f=s(()=>e.value.experimentId===null?!1:Object.keys(n.value.model.experiments.experimentGroupAssignment).includes(e.value.experimentId)),P=s(()=>{if(e.value.variantId===null||e.value.experimentId===null)return!1;const l=e.value.variantId==="Control group"?null:e.value.variantId;return n.value.model.experiments.experimentGroupAssignment[e.value.experimentId]?.variantId===l});return(l,t)=>{const a=B("meta-no-seatbelts");return v(),I(r(Q),{"modal-title":"Join an Experiment",action:O,"trigger-button-label":"Join Experiment",variant:"warning","ok-button-label":"Save","ok-button-disabled-tooltip":c.value,permission:"api.players.edit_experiment_groups",onShow:C,"data-testid":"action-join-experiment"},{default:u(()=>[j.value?(v(),D("div",W,[x("div",null,[t[5]||(t[5]=o("You can manually enroll ",-1)),p(r(M),null,{default:u(()=>[o(q(r(n).model.playerName),1)],void 0,!0),_:1}),t[6]||(t[6]=o(" in an active experiment, or change their variant in an experiment they are already in.",-1))]),t[9]||(t[9]=x("div",{class:"tw-text-xs+ tw-text-neutral-500"},"Note: Players can never leave experiments once enrolled, but you can always change their variant. Moving a player to the control group has the same effect as removing a player from an experiment.",-1)),p(r(k),{label:"Experiment","model-value":e.value.experimentId,options:$.value,placeholder:"Select an experiment","onUpdate:modelValue":A,"data-testid":"select-experiment-dropdown"},null,8,["model-value","options"]),p(r(k),{label:"Variant","model-value":e.value.variantId,options:m.value,disabled:!e.value.experimentId,placeholder:e.value.experimentId?"Select a variant":"Select an experiment first","onUpdate:modelValue":t[0]||(t[0]=d=>e.value.variantId=d),"data-testid":"select-variant-dropdown"},null,8,["model-value","options","disabled","placeholder"]),x("div",X,[p(r(K),{"model-value":e.value.isTester,size:"small",disabled:!e.value.experimentId,"tooltip-content":c.value,"disabled-tooltip":e.value.experimentId?void 0:"Select an experiment first","onUpdate:modelValue":t[1]||(t[1]=d=>e.value.isTester=d),"data-testid":"mark-as-tester"},{default:u(()=>[...t[7]||(t[7]=[x("p",{class:"tw-font-bold"},"Mark as Tester",-1)])],void 0,!0),_:1},8,["model-value","disabled","tooltip-content","disabled-tooltip"]),p(r(L),null,{default:u(()=>[...t[8]||(t[8]=[o("As a tester, the player will be able to try out the experiment before it is enabled for everyone. This is a great way to test variants before rolling them out.",-1)])],void 0,!0),_:1})]),c.value?J("",!0):(v(),I(a,{key:0,message:"Enrolling a player to an experiment or modifying the variant will force the player to reconnect!"}))])):(v(),I(r(F),{key:0,title:"No Experiments Available"},{default:u(()=>[t[3]||(t[3]=o("There are no active experiments available in this environment. First, set them up in your game configs and then configure them from the ",-1)),p(r(U),{to:"/experiments"},{default:u(()=>[...t[2]||(t[2]=[o("experiments page",-1)])],void 0,!0),_:1}),t[4]||(t[4]=o(".",-1))],void 0,!0),_:1}))]),_:1},8,["ok-button-disabled-tooltip"])}}});export{se as default};
