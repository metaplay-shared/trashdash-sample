import{d as pe,E as oe,c as Q,a as M,o as h,q as x,m as C,t as j,k as D,j as g,f as y,D as xe,y as ze,by as Ce,af as Oe,h as F,cj as se,e8 as Ne,K as ie,ck as $e,bs as De,bJ as le,r as q,e as $,w as p,x as ke,_ as G,F as re,b as ue,Q as Se,ae as de,bD as Pe,bt as Ae}from"./index-jY1EWd09.js";import{b as ce,c as te,M as H,a as X}from"./metaListUtils-B-xQ0HnD.js";import{g as we,b as Ee}from"./localization-TVVxfgEw.js";import{C as Ie}from"./CoreUiPlacement-BNT2Q2Hu.js";import{M as Me}from"./MSingleColumnLayout-BSf_YwiY.js";import{_ as je}from"./MInputSingleSelectSwitch.vue_vue_type_script_setup_true_lang-DPh05re_.js";import{_ as fe}from"./MRawDataCard.vue_vue_type_script_setup_true_lang-Db7v8Vrj.js";import{_ as Re,a as Te}from"./MViewContainer.vue_vue_type_script_setup_true_lang-C_1W2rCL.js";import{_ as me}from"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-CqJL3vnO.js";import"./index-Dec9dGh3.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CYiRxbPX.js";class Ve{diff(e,a,t={}){let i;typeof t=="function"?(i=t,t={}):"callback"in t&&(i=t.callback);const m=this.castInput(e,t),w=this.castInput(a,t),d=this.removeEmpty(this.tokenize(m,t)),l=this.removeEmpty(this.tokenize(w,t));return this.diffWithOptionsObj(d,l,t,i)}diffWithOptionsObj(e,a,t,i){var m;const w=c=>{if(c=this.postProcess(c,t),i){setTimeout(function(){i(c)},0);return}else return c},d=a.length,l=e.length;let _=1,v=d+l;t.maxEditLength!=null&&(v=Math.min(v,t.maxEditLength));const U=(m=t.timeout)!==null&&m!==void 0?m:1/0,E=Date.now()+U,L=[{oldPos:-1,lastComponent:void 0}];let S=this.extractCommon(L[0],a,e,0,t);if(L[0].oldPos+1>=l&&S+1>=d)return w(this.buildValues(L[0].lastComponent,a,e));let P=-1/0,A=1/0;const W=()=>{for(let c=Math.max(P,-_);c<=Math.min(A,_);c+=2){let R;const T=L[c-1],J=L[c+1];T&&(L[c-1]=void 0);let O=!1;if(J){const K=J.oldPos-c;O=J&&0<=K&&K<d}const Y=T&&T.oldPos+1<l;if(!O&&!Y){L[c]=void 0;continue}if(!Y||O&&T.oldPos<J.oldPos?R=this.addToPath(J,!0,!1,0,t):R=this.addToPath(T,!1,!0,1,t),S=this.extractCommon(R,a,e,c,t),R.oldPos+1>=l&&S+1>=d)return w(this.buildValues(R.lastComponent,a,e))||!0;L[c]=R,R.oldPos+1>=l&&(A=Math.min(A,c-1)),S+1>=d&&(P=Math.max(P,c+1))}_++};if(i)(function c(){setTimeout(function(){if(_>v||Date.now()>E)return i(void 0);W()||c()},0)})();else for(;_<=v&&Date.now()<=E;){const c=W();if(c)return c}}addToPath(e,a,t,i,m){const w=e.lastComponent;return w&&!m.oneChangePerToken&&w.added===a&&w.removed===t?{oldPos:e.oldPos+i,lastComponent:{count:w.count+1,added:a,removed:t,previousComponent:w.previousComponent}}:{oldPos:e.oldPos+i,lastComponent:{count:1,added:a,removed:t,previousComponent:w}}}extractCommon(e,a,t,i,m){const w=a.length,d=t.length;let l=e.oldPos,_=l-i,v=0;for(;_+1<w&&l+1<d&&this.equals(t[l+1],a[_+1],m);)_++,l++,v++,m.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return v&&!m.oneChangePerToken&&(e.lastComponent={count:v,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=l,_}equals(e,a,t){return t.comparator?t.comparator(e,a):e===a||!!t.ignoreCase&&e.toLowerCase()===a.toLowerCase()}removeEmpty(e){const a=[];for(let t=0;t<e.length;t++)e[t]&&a.push(e[t]);return a}castInput(e,a){return e}tokenize(e,a){return Array.from(e)}join(e){return e.join("")}postProcess(e,a){return e}get useLongestToken(){return!1}buildValues(e,a,t){const i=[];let m;for(;e;)i.push(e),m=e.previousComponent,delete e.previousComponent,e=m;i.reverse();const w=i.length;let d=0,l=0,_=0;for(;d<w;d++){const v=i[d];if(v.removed)v.value=this.join(t.slice(_,_+v.count)),_+=v.count;else{if(!v.added&&this.useLongestToken){let U=a.slice(l,l+v.count);U=U.map(function(E,L){const S=t[_+L];return S.length>E.length?S:E}),v.value=this.join(U)}else v.value=this.join(a.slice(l,l+v.count));l+=v.count,v.added||(_+=v.count)}}return i}}class Be extends Ve{constructor(){super(...arguments),this.tokenize=Ue}equals(e,a,t){return t.ignoreWhitespace?((!t.newlineIsToken||!e.includes(`
`))&&(e=e.trim()),(!t.newlineIsToken||!a.includes(`
`))&&(a=a.trim())):t.ignoreNewlineAtEof&&!t.newlineIsToken&&(e.endsWith(`
`)&&(e=e.slice(0,-1)),a.endsWith(`
`)&&(a=a.slice(0,-1))),super.equals(e,a,t)}}const Fe=new Be;function qe(k,e,a){return Fe.diff(k,e,a)}function Ue(k,e){e.stripTrailingCr&&(k=k.replace(/\r\n/g,`
`));const a=[],t=k.split(/(\n|\r\n)/);t[t.length-1]||t.pop();for(let i=0;i<t.length;i++){const m=t[i];i%2&&!e.newlineIsToken?a[a.length-1]+=m:a.push(m)}return a}const We={class:"tw-py-1"},Je={class:"tw-font-semibold"},Ke={class:"tw-text-xs"},Ye={key:0,class:"tw-text-xs"},ve=pe({__name:"LocalizationSelectOption",props:{localizationId:{}},setup(k){const e=k,{data:a}=oe(we()),t=Q(()=>(a.value??[]).find(i=>i.id===e.localizationId));return(i,m)=>(h(),M("div",We,[x("p",Je,j(t.value?.name||"No Name Available"),1),x("p",Ke,j(k.localizationId),1),t.value?(h(),M("p",Ye,[m[0]||(m[0]=D("Built ",-1)),g(y(ze),{instant:y(xe).fromISO(t.value.buildStartedAt),disableTooltip:""},null,8,["instant"])])):C("",!0)]))}}),Ge={class:"tw-flex tw-flex-col tw-items-center tw-justify-between @lg:tw-flex-row"},Qe={class:"tw-w-full"},He={class:"text-right tw-w-full tw-text-xs"},Xe={class:"tw-w-full"},Ze={class:"text-right tw-w-full tw-text-xs"},et={class:"tw-flex tw-items-center tw-justify-between"},tt=["id","onClick"],ot={class:"font-weight-bold mr-2"},nt={key:3,class:"tw-ml-1 tw-text-xs tw-text-blue-400"},at={key:4,class:"mt-2"},st={class:"diff text-monospace"},it={key:0},lt={key:1},rt={class:"added"},ut={key:2},dt={class:"removed"},Lt=pe({__name:"LocalizationDiffView",setup(k){const e=De(),a=Ce(),t=Oe(),{data:i}=oe(Ee("$active")),{data:m}=oe(we()),w={},d=F(se(a.query,"baselineRoot")),l=F(se(a.query,"newRoot"));Ne(async()=>{await Promise.all([E(d.value),E(l.value)])}),ie(d,async()=>{P.value=c(d.value),P.value||await E(d.value),_()}),ie(l,async()=>{A.value=c(l.value),A.value||await E(l.value),_()}),$e(()=>{i.value&&(w[i.value.info.id]=i.value,d.value??=i.value.info.id,l.value??=i.value.info.id)});function _(){const o=a.path,n={baselineRoot:d.value,newRoot:l.value};t.replace({path:o,query:n}).catch(u=>{if(u instanceof Error&&u.name!=="NavigationDuplicated")throw Error(u.message)})}const{showSuccessNotification:v}=Ae();function U(){const o=d.value;d.value=l.value,l.value=o,v("Localizations swapped.")}async function E(o){if(o!==void 0&&L.value!=="Error"&&w[o]===void 0){L.value="Loading",w[o]=null;try{const u=(await e.get(`/localization/${o}`)).data;u.info.bestEffortStatus!=="Success"?(S.value=new le(`Failed to load diff source ${o}`,`The status of the localization was ${u.info.bestEffortStatus}, expected status was Success. You can't compare against this localization because it failed to build.`),L.value="Error"):(w[o]=u,L.value!=="Error"&&!Object.values(w).some(I=>I==null)&&(P.value=c(d.value),A.value=c(l.value),L.value="Loaded"))}catch(n){S.value=new le("Oh no, something went wrong while trying to compare two localizations:",n.message),L.value="Error"}}}const L=F("Loading"),S=F(),P=F(),A=F(),W=Q(()=>{const o=P.value,n=A.value;if(!o||!n)return[];const u=[],I=Object.keys(n),V=Object.keys(o);return I.forEach(r=>{const z=n[r]??null,b=o[r]??null;if(z===null){b&&u.push({anchorName:`${r}-whole-library`,displayName:r,languageName:r,itemName:"",reason:"Added"});return}b!==null&&Object.keys(z).forEach(f=>{Object.prototype.hasOwnProperty.call(b,f)||u.push({anchorName:`${r}-${f}`,displayName:`${r}.${f}`,languageName:r,itemName:f,reason:"Added"})})}),V.forEach(r=>{const z=o[r]??null,b=n[r]??null;if(z===null){b&&u.push({anchorName:`${r}-whole-library`,displayName:r,languageName:r,itemName:"",reason:"Removed"});return}b!==null&&Object.keys(z).forEach(f=>{Object.prototype.hasOwnProperty.call(b,f)||u.push({anchorName:`${r}-${f}`,displayName:`${r}.${f}`,languageName:r,itemName:f,reason:"Removed"})})}),V.forEach(r=>{const z=o[r]??null,b=n[r]??null;!z||!b||Object.keys(z).forEach(f=>{if(Object.prototype.hasOwnProperty.call(b,f)){const B=JSON.stringify(z[f]),s=JSON.stringify(b[f]);B!==s&&(!B.startsWith('"#missing#')||!s.startsWith('"#missing#'))&&u.push({anchorName:`${r}-${f}`,displayName:`${r}.${f}`,languageName:r,itemName:f,reason:"Modified"})}})}),u.sort((r,z)=>{const b=r.anchorName.toLowerCase(),f=z.anchorName.toLowerCase();return b<f?-1:b>f?1:0}),u});function c(o){const n=w[o??""];if(n){const u={};return Object.entries(n.locs).forEach(([I,V])=>{u[I]=V.translations}),u}else return}function R(o,n){let u={};Object.prototype.hasOwnProperty.call(P.value?.[o],n)&&(u=P.value?.[o][n]);let I={};Object.prototype.hasOwnProperty.call(A.value?.[o],n)&&(I=A.value?.[o][n]);const V=T(u),r=T(I),z=qe(V,r),b=[];return z.forEach(f=>{let B="Unchanged";f.added?B="Added":f.removed&&(B="Removed");const s=f.value.split(/\r?\n/).slice(0,f.count);b.push(...s.map(ee=>{const N=ee.split(":")[0],ae=N.replace(/"/g,""),Le=ee.replace(N,ae);return{reason:B,text:Le}}))}),b}function T(o){return typeof o=="string"?`  "${o}"`:typeof o=="number"?`  ${o}`:Object.keys(o).length===0?" ":JSON.stringify(o,(n,u)=>u,2).slice(2,-2)}const J=[{label:"Baseline",value:"Baseline"},{label:"Full Diff",value:"Diff"},{label:"Only Additions",value:"Additions"},{label:"New",value:"Destination"}],O=F("Diff");function Y(o){return O.value==="Diff"||O.value==="Additions"&&o!=="Removed"||O.value==="Baseline"&&o!=="Added"?!0:O.value==="Destination"&&o!=="Removed"}const K=F([]);function he(o){const n=K.value.indexOf(o);n===-1?K.value.push(o):K.value.splice(n,1)}function Z(o){return!K.value.includes(o)}const ye=Q(()=>[ce.asDynamicFilterSet(W.value,"library",o=>o.languageName),new ce("reason",[new te("Modified",o=>o.reason==="Modified"),new te("Added",o=>o.reason==="Added"),new te("Removed",o=>o.reason==="Removed")])]),_e=[new H("Name","displayName",X.Ascending),new H("Name","displayName",X.Descending),new H("Reason","reason",X.Ascending),new H("Reason","reason",X.Descending)],be=Q(()=>d.value===l.value?"You are comparing a localization version against itself. Unsurprisingly, this means that there are no differences to be found ðŸ¤”":"No differences found between the two localization versions ðŸ¤”"),ne=Q(()=>ge.value.map(o=>{const n=m.value?.find(u=>u.id===o);return{label:`${o} - ${n?.name||"No Name Available"}`,value:o}})),ge=Q(()=>(m.value??[]).filter(o=>o.bestEffortStatus==="Success"&&!o.isArchived).map(o=>o.id));return(o,n)=>{const u=q("fa-icon"),I=q("meta-list-card"),V=q("b-card-title"),r=q("b-card-body"),z=q("meta-lazy-loader"),b=q("b-list-group-item"),f=q("b-list-group"),B=q("b-card");return h(),$(y(Te),{permission:"api.localization.view","is-loading":!y(i)||!y(m),error:S.value,"full-width-overview":""},{overview:p(()=>[g(y(Re),{title:"Compare Game Config Versions",subtitle:"Select two localizations to compare the differences between them. You can view the differences in the full diff, or filter them to only show additions, removals, or modifications."},{default:p(()=>[x("div",Ge,[x("div",Qe,[g(y(me),{label:"Baseline Localization","model-value":d.value,options:ne.value,"onUpdate:modelValue":n[0]||(n[0]=s=>d.value=s)},{option:p(({option:s})=>[s.value?(h(),$(ve,{key:0,localizationId:s.value},null,8,["localizationId"])):C("",!0)]),_:1},8,["model-value","options"]),x("div",He,[g(y(de),{to:`/localizations/${d.value}`},{default:p(()=>[...n[3]||(n[3]=[D("View baseline localization",-1)])],void 0,!0),_:1},8,["to"])])]),g(y(Pe),{class:"tw-m-4","aria-label":"Swap the baseline and new localizations.",onClick:U},{default:p(()=>[g(u,{icon:"right-left"})],void 0,!0),_:1}),x("div",Xe,[g(y(me),{label:"New Localization","model-value":l.value,options:ne.value,"onUpdate:modelValue":n[1]||(n[1]=s=>l.value=s)},{option:p(({option:s})=>[s.value?(h(),$(ve,{key:0,localizationId:s.value},null,8,["localizationId"])):C("",!0)]),_:1},8,["model-value","options"]),x("div",Ze,[g(y(de),{to:`/localizations/${l.value}`},{default:p(()=>[...n[4]||(n[4]=[D("View new localization",-1)])],void 0,!0),_:1},8,["to"])])])])],void 0,!0),_:1})]),default:p(()=>[g(Ie,{placementId:"Localizations/Diff"}),g(y(Me),{class:"tw-mb-5"},{default:p(()=>[g(I,{title:"Overview of changes",itemList:L.value==="Loading"?void 0:W.value,searchFields:["displayName"],filterSets:ye.value,sortOptions:_e,emptyMessage:be.value,"page-size":15},{"item-card":p(s=>[g(y(ke),null,{default:p(()=>[s.item.reason==="Added"?(h(),$(y(G),{key:0,class:"mr-2",variant:"success",tooltip:"Added"},{default:p(()=>[...n[5]||(n[5]=[D("A",-1)])],void 0,!0),_:1})):C("",!0),s.item.reason==="Removed"?(h(),$(y(G),{key:1,class:"mr-2",variant:"danger",tooltip:"Removed"},{default:p(()=>[...n[6]||(n[6]=[D("R",-1)])],void 0,!0),_:1})):C("",!0),s.item.reason==="Modified"?(h(),$(y(G),{key:2,class:"mr-2",variant:"primary",tooltip:"Modified"},{default:p(()=>[...n[7]||(n[7]=[D("M",-1)])],void 0,!0),_:1})):C("",!0),x("span",null,j(s.item.displayName),1)],void 0,!0),_:2},1024)]),_:1},8,["itemList","filterSets","emptyMessage"])],void 0,!0),_:1}),W.value.length>0?(h(),$(B,{key:0,class:"shadow-sm mb-3 tw-mx-3","no-body":""},{default:p(()=>[g(r,null,{default:p(()=>[x("div",et,[g(V,{class:"tw-pt-3"},{default:p(()=>[...n[8]||(n[8]=[D("Detailed Changes",-1)])],void 0,!0),_:1}),g(y(je),{"model-value":O.value,options:J,"onUpdate:modelValue":n[2]||(n[2]=s=>O.value=s)},null,8,["model-value"])])],void 0,!0),_:1}),g(f,{class:"list-group-stripes",flush:""},{default:p(()=>[(h(!0),M(re,null,ue(W.value,(s,ee)=>(h(),$(b,{key:s.anchorName},{default:p(()=>[g(z,{renderAfterDelayInMs:50},{default:p(()=>[x("div",{id:s.anchorName,style:{cursor:"pointer"},onClick:N=>he(s.anchorName)},[x("span",{class:Se({"not-collapsed":!Z(s.anchorName)})},[Y(s.reason)?(h(),$(u,{key:0,class:"mr-2",icon:"angle-right"})):C("",!0)],2),x("span",ot,j(s.languageName)+j(s.itemName!==""?".":"")+j(s.itemName),1),s.reason==="Added"?(h(),$(y(G),{key:0,variant:"success"},{default:p(()=>[...n[9]||(n[9]=[D("Added",-1)])],void 0,!0),_:1})):C("",!0),s.reason==="Removed"?(h(),$(y(G),{key:1,variant:"danger"},{default:p(()=>[...n[10]||(n[10]=[D("Removed",-1)])],void 0,!0),_:1})):C("",!0),s.reason==="Modified"?(h(),$(y(G),{key:2,variant:"primary"},{default:p(()=>[...n[11]||(n[11]=[D("Modified",-1)])],void 0,!0),_:1})):C("",!0),Y(s.reason)?(h(),M("span",nt,j(Z(s.anchorName)?"Show":"Hide"),1)):C("",!0),!Z(s.anchorName)&&Y(s.reason)?(h(),M("div",at,[(h(!0),M(re,null,ue(R(s.languageName,s.itemName),(N,ae)=>(h(),M("div",st,[["Diff","Baseline","Destination"].includes(O.value)&&N.reason=="Unchanged"?(h(),M("div",it,j(N.text),1)):C("",!0),["Diff","Additions","Destination"].includes(O.value)&&N.reason=="Added"?(h(),M("div",lt,[n[12]||(n[12]=x("span",{class:"text-success"},"+",-1)),n[13]||(n[13]=D()),x("span",rt,j(N.text.slice(2,N.text.length)),1)])):["Diff","Baseline"].includes(O.value)&&N.reason=="Removed"?(h(),M("div",ut,[n[14]||(n[14]=x("span",{class:"text-danger"},"-",-1)),n[15]||(n[15]=D()),x("span",dt,j(N.text.slice(2,N.text.length)),1)])):C("",!0)]))),256))])):C("",!0)],8,tt)],void 0,!0),_:2},1024)],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})],void 0,!0),_:1})):C("",!0),g(y(fe),{data:P.value,label:"baselineLocalization"},null,8,["data"]),g(y(fe),{data:A.value,label:"newLocalization"},null,8,["data"])],void 0,!0),_:1},8,["is-loading","error"])}}});export{Lt as default};
