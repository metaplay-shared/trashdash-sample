import{d as Y,h as b,c as z,r as C,e as u,o as r,w as a,q as n,j as v,f as o,v as N,a as d,F as O,b as G,x as j,k as s,t as m,m as I,ae as B,_ as h,a6 as A,bl as H,ah as J,bH as D,cG as F,bs as L}from"./index-B-VT6L6o.js";import{_ as K}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CzHe6hW1.js";import{_ as Q}from"./MInputTextArea.vue_vue_type_script_setup_true_lang-CaKBOzTC.js";import{_ as X}from"./MInputSingleFileContents.vue_vue_type_script_setup_true_lang-CgnKBW1n.js";import{_ as Z}from"./MInputSingleSelectSwitch.vue_vue_type_script_setup_true_lang-CetibaW-.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-DbjMhR13.js";import"./index-D9XvAc_V.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CBCiJKqn.js";import"./debounce-B6LajIyo.js";import"./isSymbol-BpirMJeh.js";import"./MInputSingleFile-CNXgN5gF.js";import"./index-llZsRYZ2.js";import"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-Dv81Anyh.js";const ee={class:"tw-flex tw-justify-end"},te={class:"tw-mb-4"},ae={class:"font-weight-bold"},re={key:0},ie={class:"tw-text-red-500"},oe={key:0,class:"tw-text-red-500"},se={key:1},le={key:3,class:"tw-mt-4"},ne={class:"code-box text-monospace border rounded bg-light tw-w-full",style:{"max-height":"20.3rem"}},ue={key:0},de={key:1},ve={key:2},ce={key:0},pe={key:0},me={key:1},Pe=Y({__name:"ImportEntities",setup(fe){const P=L(),f=b(""),w=b(),c=b(),y=b(""),_=b(),p=b("ignore");function M(t){p.value=t,$(w.value??f.value).catch(e=>{console.error(e)})}const E=b(),g=z(()=>{if(!((f.value!==""||w.value!==null)&&!c.value))return!!c.value}),R=[{value:"ignore",label:"Ignore"},{value:"overwrite",label:"Overwrite"},{value:"createnew",label:"Create New"}];function W(){f.value="",w.value=void 0,c.value=void 0,_.value=void 0,p.value="ignore"}let x;async function $(t){if(_.value=void 0,c.value=void 0,y.value="",t){let e;try{e=V(t)}catch(l){_.value=new D("Calculating payload failed",l.message);return}try{x&&x.cancel("Request canceled by user interaction."),x=F.CancelToken.source();const l=(await P.post(`/entityArchive/validate?overwritePolicy=${p.value}`,e)).data;l.error?_.value=new D("Validation failed",l.error.message,500,void 0,[{title:"Details",content:l.error.details}]):(c.value=l.entities,l.entities.map(k=>(k.overwriteDiff!==null&&(y.value=k.overwriteDiff),y.value)))}catch(l){F.isCancel(l)||(_.value=new D("Validation failed",l.response.data.error.message))}}}function S(t,e){return t.status==="Success"&&p.value==="ignore"?e==="preview"?"New entity will be created.":"New entity created.":t.status==="Ignored"?e==="preview"?"Existing entity will be preserved.":`Existing entity ${t.sourceId} has been preserved.`:t.status==="Success"&&p.value==="overwrite"&&t.overwriteDiff!==null?e==="preview"?"Existing entity will be overwritten.":`Existing entity ${t.sourceId} has been overwritten.`:t.status==="Success"&&p.value==="overwrite"&&t.overwriteDiff===null?e==="preview"?"New entity will be created.":"New entity created.":t.status==="Success"&&p.value==="createnew"?e==="preview"?`A new entity will be created from ${t.sourceId}.`:`A new entity ${t.destinationId} has been created. `:""}function q(t){f.value=t,$(t)}function T(t){w.value=t,$(t)}async function U(t){const e=V(t),l=(await P.post(`/entityArchive/import?overwritePolicy=${p.value}`,e)).data;if(l.error)throw new Error(`${l.error.message}
${l.error.details}`);E.value=l.entities}function V(t){let e;try{e=JSON.parse(t)}catch(l){throw new Error(`Could not parse archive. Got '${l.message}'.`)}if(typeof e!="object")throw new Error(`Entity archive must be an object. Got '${typeof e}'.`);if(Array.isArray(e))throw new Error("Entity archive must be an object. Got 'array'.");if(!("entities"in e))throw new Error("Entity archive must contain entities but none found.");return e}return(t,e)=>{const l=C("meta-no-seatbelts"),k=C("fa-icon");return r(),u(o(J),{title:"Import Game Entities"},{subtitle:a(()=>e[0]||(e[0]=[n("p",null,"You can use this feature to import an archive of one or more game entities into the current deployment.",-1)])),default:a(()=>[n("div",ee,[v(o(K),{"modal-title":"Import Game Entities",action:()=>U(w.value??f.value),"trigger-button-label":"Open Import Menu","ok-button-label":"Import Archive","ok-button-disabled-tooltip":g.value?void 0:"Paste in or upload a valid entity archive to proceed.",permission:"api.entity_archive.import",onShow:W,"data-testid":"batch-import-entities"},{default:a(()=>[e[4]||(e[4]=n("h6",{class:"tw-mb-1"},"Paste Archive Data",-1)),n("p",te,[e[2]||(e[2]=s("You can upload the serialized data of an ",-1)),v(o(h),null,{default:a(()=>e[1]||(e[1]=[s("entity archive",-1)]),void 0,!0),_:1,__:[1]}),e[3]||(e[3]=s(" here to import them into the current deployment.",-1))]),v(o(Q),{class:"tw-mb-2",label:"Paste in an archive...","model-value":f.value,placeholder:w.value!=null?"File upload selected":"{'entities':{'player':...",variant:g.value!==void 0?g.value?"success":"danger":"default",rows:5,disabled:!!w.value,"onUpdate:modelValue":q,"data-testid":"entity-archive-text"},null,8,["model-value","placeholder","variant","disabled"]),v(o(X),{class:"tw-mb-3",label:"...or upload a file...","model-value":w.value,placeholder:f.value!==""?"Manual paste selected":"Choose or drop an entity archive file",variant:g.value!==void 0?g.value?"success":"danger":"default",disabled:f.value!=="","accepted-file-types":".json","onUpdate:modelValue":T,"data-testid":"entity-archive-file"},null,8,["model-value","placeholder","variant","disabled"]),v(o(Z),{"model-value":p.value,options:R,label:"Overwrite policy","onUpdate:modelValue":M},null,8,["model-value"]),e[5]||(e[5]=n("div",{class:"tw-mt-2 tw-text-xs tw-text-neutral-500"},[n("p",null,"Overwrite policy determines how to deal with conflicting entities during import:"),n("p",{class:"tw-m-0.5"},[n("span",{class:"tw-font-semibold"},"Ignore"),s(" - Duplicate entities will not be imported.")]),n("p",{class:"tw-m-0.5"},[n("span",{class:"tw-font-semibold"},"Overwrite"),s(" - Duplicate entities will overwrite existing ones.")]),n("p",{class:"tw-m-0.5"},[n("span",{class:"tw-font-semibold"},"Create New"),s(" - Duplicate entities will be imported as new entities with new unique ID's.")])],-1))]),"right-panel":a(()=>[e[12]||(e[12]=n("h6",{class:"tw-mb-4"},"Preview Incoming Data",-1)),!c.value&&!_.value?(r(),u(o(A),{key:0,title:"Preview",variant:"neutral"},{default:a(()=>[e[7]||(e[7]=s("Paste in a valid ",-1)),v(o(h),null,{default:a(()=>e[6]||(e[6]=[s("entity archive",-1)]),void 0,!0),_:1,__:[6]}),e[8]||(e[8]=s(" from a compatible game version to preview what data will be copied over.",-1))],void 0,!0),_:1,__:[7,8]})):c.value&&c.value.length>0?(r(),u(o(N),{key:1,showBorder:""},{default:a(()=>[(r(!0),d(O,null,G(c.value,i=>(r(),u(o(j),{class:"tw-px-3",key:i.sourceId},{"top-right":a(()=>[i.error?(r(),u(o(h),{key:1,variant:"danger"},{default:a(()=>e[10]||(e[10]=[s("Validation error",-1)]),void 0,!0),_:1,__:[10]})):(r(),u(o(h),{key:0,variant:"success"},{default:a(()=>e[9]||(e[9]=[s("Validation ok",-1)]),void 0,!0),_:1,__:[9]}))]),"bottom-left":a(()=>[i.error?(r(),d("span",re,[n("div",ie,m(i.error.message),1),i.error.details?(r(),d("div",oe,m(i.error.details),1)):I("",!0)])):(r(),d("span",se,m(S(i,"preview")),1))]),default:a(()=>[n("span",ae,"Source: "+m(i.sourceId),1)],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})):(r(),u(o(A),{key:2,title:"Empty Archive"},{default:a(()=>e[11]||(e[11]=[s("Entity archive is empty. Are you sure you pasted the right thing?",-1)]),void 0,!0),_:1,__:[11]})),y.value?(r(),d("div",le,[n("div",ne,[n("pre",null,m(y.value),1)])])):I("",!0),_.value?(r(),u(o(H),{key:4,error:_.value},null,8,["error"])):I("",!0)]),"bottom-panel":a(()=>[v(l,{class:"tw-mx-auto tw-w-7/12"})]),"result-panel":a(()=>[e[19]||(e[19]=n("p",{class:"tw-mb-4"},"Import complete, below are the results:",-1)),E.value&&E.value.length>0?(r(),u(o(N),{key:0,showBorder:""},{default:a(()=>[(r(!0),d(O,null,G(E.value,i=>(r(),u(o(j),{class:"tw-px-3",key:i.sourceId},{"top-right":a(()=>[i.status==="Success"?(r(),u(o(h),{key:0,variant:"success"},{default:a(()=>e[13]||(e[13]=[s("Imported",-1)]),void 0,!0),_:1,__:[13]})):i.status==="Error"?(r(),u(o(h),{key:1,variant:"danger"},{default:a(()=>e[14]||(e[14]=[s("Error",-1)]),void 0,!0),_:1,__:[14]})):(r(),u(o(h),{key:2,variant:"warning"},{default:a(()=>e[15]||(e[15]=[s("Skipped",-1)]),void 0,!0),_:1,__:[15]}))]),"bottom-left":a(()=>[s(m(S(i)),1)]),"bottom-right":a(()=>[i.status==="Success"?(r(),d("span",ce,[String(i.destinationId).startsWith("Player")?(r(),d("span",pe,[v(o(B),{to:`/players/${i.destinationId}`},{default:a(()=>e[16]||(e[16]=[s("View player",-1)]),void 0,!0),_:2,__:[16]},1032,["to"])])):String(i.destinationId).startsWith("Guild")?(r(),d("span",me,[v(o(B),{to:`/guilds/${i.destinationId}`},{default:a(()=>e[17]||(e[17]=[s("View guild",-1)]),void 0,!0),_:2,__:[17]},1032,["to"])])):I("",!0)])):I("",!0)]),default:a(()=>[String(i.destinationId).startsWith("Player")?(r(),d("span",ue,[v(k,{icon:"user"}),s(" "+m(i.destinationId),1)])):String(i.destinationId).startsWith("Guild")?(r(),d("span",de,[v(k,{icon:"chess-rook"}),s(" "+m(i.destinationId)+"]",1)])):(r(),d("span",ve,m(i.destinationId),1))],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})):(r(),u(o(A),{key:1,title:"Empty Archive"},{default:a(()=>e[18]||(e[18]=[s("Empty entity archive. Nothing was imported.",-1)]),void 0,!0),_:1,__:[18]}))]),_:1},8,["action","ok-button-disabled-tooltip"])])],void 0,!0),_:1})}}});export{Pe as default};
