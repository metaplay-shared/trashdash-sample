import{d as R,E as q,h as u,c as H,r as U,e as _,m as w,f as r,o as d,I as z,w as y,j as E,q as i,a as k,a6 as $,k as c,F as J,b as L,t as P,bl as Y,_ as K,bH as x,cG as N,bs as Q,bt as W}from"./index-B-VT6L6o.js";import{a as X}from"./players-CbfgGr44.js";import{_ as Z}from"./MInputTextArea.vue_vue_type_script_setup_true_lang-CaKBOzTC.js";import{_ as ee}from"./MInputSingleFileContents.vue_vue_type_script_setup_true_lang-CgnKBW1n.js";import{_ as ae}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CzHe6hW1.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CBCiJKqn.js";import"./debounce-B6LajIyo.js";import"./isSymbol-BpirMJeh.js";import"./MInputSingleFile-CNXgN5gF.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-DbjMhR13.js";import"./index-D9XvAc_V.js";const te={class:"tw-mb-2"},re={class:"tw-mr-1"},le={key:3},oe={class:"code-box text-monospace border rounded bg-light tw-w-full",style:{"max-height":"20.3rem"}},we=R({__name:"PlayerActionOverwrite",props:{playerId:{}},setup(T){const V=T,C=Q(),{data:v,refresh:j}=q(X(V.playerId)),n=u(""),s=u(),l=u(),b=u(!1),h=u(),o=u(),g=u(),p=H(()=>{const t=n.value!==""||s.value;return!t||t&&!o.value&&!l.value?null:!!(l.value&&b.value)});function D(t){n.value=t,A(t)}function F(t){s.value=t,A(t)}function S(){n.value="",s.value=void 0,l.value=void 0,b.value=!1,o.value=void 0}async function A(t){if(o.value=void 0,l.value=void 0,h.value=void 0,b.value=!1,t){let e;try{e=O(t)}catch(a){o.value=new x("Calculating payload failed",a.message);return}try{g.value&&g.value.cancel("Request canceled by user interaction."),g.value=N.CancelToken.source();const a=(await C.post(`/players/${v.value.id}/validateOverwrite`,e,{cancelToken:g.value.token})).data;a.error?o.value=new x("Validation failed",a.error.message,500,void 0,[{title:"Details",content:a.error.details}]):a.data.diff===""?l.value=`No differences in player model data.
Did you paste in the correct player?`:(l.value=a.data.diff,b.value=!0)}catch(a){N.isCancel(a)||a.response&&(o.value=new x("Validaiton failed",a.response.data.error.message))}}}const{showSuccessNotification:G}=W();async function I(t){const e=O(t);await C.post(`/players/${v.value.id}/importOverwrite`,e),G("Player import succeeded."),j()}function O(t){let e;try{e=JSON.parse(t)}catch(f){throw new Error(`Could not parse archive. Got '${f.message}'.`)}if(typeof e!="object")throw new Error(`Entity archive must be an object. Got '${typeof e}'.`);if(Array.isArray(e))throw new Error("Entity archive must be an object. Got 'array'.");if(!("entities"in e))throw new Error("Entity archive must contain entities but none found.");if(!("player"in e.entities))throw new Error("Entity archive must contain player entities but none found.");const a=Object.keys(e.entities.player);if(a.length!==1)throw new Error(`Entity archive may only contain exactly one player entity. Got ${a.length}.`);const m=Object.keys(e.entities).filter(f=>f!=="player");m.forEach(f=>delete e.entities[f]),m.length&&(h.value=m);const B=a[0],M=v.value.id;return e.remaps={player:{}},e.remaps.player[B]=M,e}return(t,e)=>{const a=U("meta-no-seatbelts");return r(v)?(d(),_(r(ae),{key:0,"modal-title":"Overwrite Player",action:()=>I(s.value??n.value),"trigger-button-label":"Overwrite Player",variant:"danger","ok-button-label":"Overwrite Player","ok-button-disabled-tooltip":p.value?void 0:"Paste in or upload a valid player to proceed.",permission:"api.players.overwrite",onShow:S,onHidden:S,"data-testid":"action-overwrite-player"},z({default:y(()=>[e[2]||(e[2]=i("h6",{class:"tw-mb-1"},"Paste Player Data",-1)),i("p",te,[e[0]||(e[0]=c("You can copy & paste the serialized data of a compatible player here to overwrite parts of ",-1)),E(r(K),null,{default:y(()=>[c(P(r(v).model.playerName||"n/a"),1)],void 0,!0),_:1}),e[1]||(e[1]=c(".",-1))]),e[3]||(e[3]=i("p",{class:"tw-mb-4"},[c("This is an "),i("span",{class:"tw-text-danger"},"advanced development feature"),c(" and should probably never be used in production!")],-1)),E(r(Z),{class:"tw-mb-2",label:"Paste in an archive...","model-value":n.value,placeholder:s.value!=null?"File upload selected":"{'entities':{'player':...",variant:p.value!==null?p.value?"success":"danger":"default",rows:5,disabled:!!s.value,"onUpdate:modelValue":D,"data-testid":"entity-archive-text"},null,8,["model-value","placeholder","variant","disabled"]),E(r(ee),{label:"...or upload a file...","model-value":s.value,placeholder:n.value!==""?"Manual paste selected":"Choose or drop an entity archive file",variant:p.value!==null?p.value?"success":"danger":"default",disabled:n.value!=="","accepted-file-types":".json","onUpdate:modelValue":F,"data-testid":"entity-archive-file"},null,8,["model-value","placeholder","variant","disabled"])]),"right-panel":y(()=>[e[6]||(e[6]=i("h6",{class:"tw-mb-4"},"Preview Incoming Data",-1)),h.value?(d(),_(r($),{key:0,class:"tw-mb-2",title:"Extra Entity Types",variant:"warning"},{default:y(()=>[i("p",null,[e[4]||(e[4]=c("Archive contained the following extra entity types that were removed: ",-1)),(d(!0),k(J,null,L(h.value,m=>(d(),k("span",re,P(m),1))),256))])],void 0,!0),_:1})):w("",!0),!l.value&&!o.value?(d(),_(r($),{key:1,class:"tw-mb-2",title:"Preview",variant:"neutral"},{default:y(()=>e[5]||(e[5]=[c("Paste in a valid player from a compatible game version to preview what data will be copied over.",-1)]),void 0,!0),_:1,__:[5]})):w("",!0),o.value?(d(),_(r(Y),{key:2,class:"tw-mb-2",error:o.value},null,8,["error"])):w("",!0),l.value?(d(),k("div",le,[i("div",oe,[i("pre",null,P(l.value),1)])])):w("",!0)]),_:2},[p.value?{name:"bottom-panel",fn:y(()=>[E(a,{class:"tw-mx-auto tw-w-7/12",name:r(v).model.playerName||"n/a"},null,8,["name"])]),key:"0"}:void 0]),1032,["action","ok-button-disabled-tooltip"])):w("",!0)}}});export{we as default};
