import{bo as M,bp as I,bq as V,br as $,d as O,h as C,D as g,c as d,ab as R,r as q,e as j,o as z,f as s,I as G,w as m,j as n,ag as K,q as r,bs as Z,bt as H}from"./index-jY1EWd09.js";import{_ as J}from"./MetaGeneratedForm.vue_vue_type_script_setup_true_lang-C4tXbiPC.js";import{_ as F}from"./PlayerSegmentsInput.vue_vue_type_script_setup_true_lang-0j5ld439.js";import{_ as Q}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CTycXHot.js";import{_ as W}from"./MInputSwitch.vue_vue_type_script_setup_true_lang-D2jAqk4R.js";import{_ as X}from"./MInputNumber.vue_vue_type_script_setup_true_lang-B50CLeRK.js";import{_ as A}from"./MInputText.vue_vue_type_script_setup_true_lang-Wwv8TYAB.js";import{_ as Y}from"./MInputDateTime.vue_vue_type_script_setup_true_lang-BJgw3K8v.js";function de(){return{permission:"api.notifications.view",pollingPolicy:V(5e3),fetcherPolicy:I("/notifications"),cacheRetentionPolicy:M()}}function me(l){return{permission:"api.notifications.view",pollingPolicy:V(5e3),fetcherPolicy:I(`/notifications/${l}`),cacheRetentionPolicy:$(1e4)}}const ee={class:"tw-inline-flex tw-w-full tw-gap-x-4"},te={class:"tw-@container"},ae={class:"tw-mt-4 tw-rounded tw-border tw-border-neutral-200 tw-bg-neutral-100 tw-p-3"},f=50,fe=O({__name:"NotificationFormButton",props:{modalTitle:{},buttonText:{},oldNotification:{},update:{type:Boolean},buttonIcon:{}},emits:["refresh"],setup(l,{emit:k}){const o=l,v=Z(),{isDeveloperUiEnabled:T}=K(),e=C(y());function y(){return{name:"",targetTime:g.utc(),content:{title:void 0,body:void 0},debugEntityIdValueUpperBound:100,debugFakeNotificationMode:!1,firebaseAnalyticsLabel:"",audience:F.props.modelValue.default()}}function S(t){e.value.name=t,L()}const p=d(()=>!(!e.value.name||e.value.name.length===0));function L(){e.value.firebaseAnalyticsLabel=P(e.value.name)}const w=["-","_",".","~","%"];function P(t){let a="";for(let u=0;u<t.length;u++){const i=t.charAt(u);N(i)?a+=i:i===" "?a+="_":a+="%"}return a.length>f&&(a=a.substring(0,f)),a}function N(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"||w.includes(t)}const b=d(()=>{const t=e.value.firebaseAnalyticsLabel;if(t.length>f)return!1;for(let a=0;a<t.length;a++)if(!N(t.charAt(a)))return!1;return t?!0:null}),c=C(!1),U=d(()=>{if(!p.value&&!c.value)return"Fill in the required fields to proceed.";if(!p.value)return"Fill in a valid name to proceed.";if(!c.value)return"Fill in the notification message in all selected locales to proceed.";if(!e.value.audience.valid)return"The audience targeting is invalid. Check that it is filled out correctly to proceed.";if(!b.value)return"The Firebase analytics label is invalid. Check that it is set correctly to proceed."});function _(t){t&&(e.value.targetTime=t)}const x=k,{showSuccessNotification:h}=H();async function B(){const t={name:e.value.name,targetTime:e.value.targetTime.toISO(),content:e.value.content,firebaseAnalyticsLabel:e.value.firebaseAnalyticsLabel,targetPlayers:e.value.audience.targetPlayers,targetCondition:e.value.audience.targetCondition};if(e.value.debugFakeNotificationMode&&(t.debugFakeNotificationMode=!0,t.debugEntityIdValueUpperBound=e.value.debugEntityIdValueUpperBound),o.update){if(t.id=o.oldNotification?.id,!t.id)throw new Error("Cannot update campaign without ID.");await v.put(`/notifications/${t.id}`,t),h("Campaign updated.")}else await v.post("/notifications",t),h("New push notification campaign created.");x("refresh")}function E(){o.oldNotification?(e.value.name=o.update?o.oldNotification.name:o.oldNotification.name+" (copy)",e.value.targetTime=o.update?g.fromISO(o.oldNotification.targetTime):g.utc(),e.value.content=o.oldNotification.content,e.value.debugFakeNotificationMode=o.oldNotification.debugFakeNotificationMode??!1,e.value.debugEntityIdValueUpperBound=o.oldNotification.debugEntityIdValueUpperBound??100,e.value.firebaseAnalyticsLabel=o.oldNotification.firebaseAnalyticsLabel,e.value.audience.targetPlayers=o.oldNotification.targetPlayers,e.value.audience.targetCondition=o.oldNotification.targetCondition,c.value=!0):e.value=y()}const D=d(()=>R().featureFlags.pushNotifications);return(t,a)=>{const u=q("fa-icon");return z(),j(s(Q),{"modal-title":l.modalTitle,action:B,"trigger-button-label":l.buttonText,"trigger-button-disabled-tooltip":D.value?void 0:"Push notifications are not enabled for this deployment.","ok-button-label":"Start Campaign","ok-button-disabled-tooltip":U.value,permission:"api.notifications.edit",onShow:E},G({"right-panel":m(()=>[r("div",te,[n(J,{class:"tw-mt-3",typeName:"Metaplay.Server.NotificationCampaign.NotificationContent",value:e.value.content,page:"NotificationFormButton","is-targeting-multiple-players":"",onInput:a[2]||(a[2]=i=>e.value.content=i),onStatus:a[3]||(a[3]=i=>c.value=i)},null,8,["value"])])]),default:m(()=>[r("div",ee,[n(s(A),{class:"tw-grow",label:"Campaign Name","model-value":e.value.name,variant:p.value?"success":"danger",placeholder:"Campaign name here...","onUpdate:modelValue":S},null,8,["model-value","variant"]),n(s(Y),{class:"tw-grow","model-value":e.value.targetTime,"min-date-time":"utcNow",label:"Date","onUpdate:modelValue":_},null,8,["model-value"])]),n(s(A),{class:"tw-mt-3",label:"Firebase Analytics Label","model-value":e.value.firebaseAnalyticsLabel,variant:b.value!==null?b.value?"success":"danger":void 0,placeholder:"Optional analytics label...","hint-message":`At most ${f} characters; ASCII alphanumerics and ${w.join(" ")}`,"onUpdate:modelValue":a[0]||(a[0]=i=>e.value.firebaseAnalyticsLabel=i)},null,8,["model-value","variant","hint-message"]),n(F,{class:"tw-mt-3","model-value":e.value.audience,"onUpdate:modelValue":a[1]||(a[1]=i=>e.value.audience=i)},null,8,["model-value"])],void 0,!0),_:2},[l.buttonIcon?{name:"trigger-button-icon",fn:m(()=>[n(u,{class:"tw-mb-[0.05rem] tw-h-3.5 tw-w-4 tw-space-x-2",icon:l.buttonIcon},null,8,["icon"])]),key:"0"}:void 0,s(T)?{name:"bottom-panel",fn:m(()=>[r("div",ae,[a[6]||(a[6]=r("span",{class:"tw-mr-1 tw-font-semibold"},"Debug Options",-1)),a[7]||(a[7]=r("span",{class:"tw-space-x-1 tw-text-xs+ tw-normal-case tw-text-neutral-500"},[r("span",null,"Visible in developer mode."),r("span",{class:"tw-text-red-500"},"Do not use these in production!")],-1)),n(s(W),{class:"tw-mt-2","model-value":e.value.debugFakeNotificationMode,label:"Fake notification mode",name:"fakeNotificationModeEnabled",size:"small","onUpdate:modelValue":a[4]||(a[4]=i=>e.value.debugFakeNotificationMode=i)},null,8,["model-value"]),n(s(X),{label:"Debug Entity ID Bound","model-value":e.value.debugEntityIdValueUpperBound,disabled:!e.value.debugFakeNotificationMode,min:1,"hint-message":"Set this to the number of bots you are running for best results.","onUpdate:modelValue":a[5]||(a[5]=i=>e.value.debugEntityIdValueUpperBound=i)},null,8,["model-value","disabled"])])]),key:"1"}:void 0]),1032,["modal-title","trigger-button-label","trigger-button-disabled-tooltip","ok-button-disabled-tooltip"])}}});export{fe as _,me as a,de as g};
