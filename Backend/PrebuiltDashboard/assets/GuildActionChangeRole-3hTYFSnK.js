import{d as K,E as Q,c as h,h as b,e9 as m,K as j,i as Y,bs as H,r as L,e as _,o as p,w as s,q as f,j as d,a as S,f as o,k as v,t as y,_ as x,Q as B,a6 as J,v as W,F as X,b as Z,x as q,ae as ee,bt as ae}from"./index-B-VT6L6o.js";import{a as le}from"./guilds-B8vDp8y0.js";import{_ as G}from"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-Dv81Anyh.js";import{_ as te}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CzHe6hW1.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CBCiJKqn.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-DbjMhR13.js";import"./index-D9XvAc_V.js";const oe={class:"tw-flex tw-items-center tw-justify-between tw-text-sm"},se={class:"tw-text-neutral-400"},ie={key:0},re={key:1,class:"text-muted mb-3 small tw-pt-4 tw-text-center tw-italic"},fe=K({__name:"GuildActionChangeRole",props:{guildId:{}},setup(M){const P=M,$=H(),{data:u,refresh:V}=Q(le(P.guildId)),O=h(()=>Object.keys(u.value.model.members).length!==0),c=b([]);function D(t,e){return t.filter(n=>(e=e.toLocaleLowerCase(),!!(n.value?.displayName?.toLocaleLowerCase().includes(e)||n.value?.playerId?.toLocaleLowerCase().includes(e)||n.value?.roleId?.toLocaleLowerCase().includes(e))))}const l=b(c.value[0]?.value),E=h(()=>["Leader","MiddleTier","LowTier"].map(t=>({label:m(t),value:{id:t,displayName:m(t)},disabled:l.value?.roleId===m(t)}))),i=b(),g=b(),r=b(),R=b(!1),T=h(()=>c.value.length===1?"This guild has only one member. You cannot change their role.":l.value?i.value?g.value?void 0:"Change is not valid.":"Select a role to proceed.":"Select a player to proceed.");function A(){l.value=c.value[0]?.value,i.value=void 0,g.value=void 0,r.value=void 0;const t=[];for(const e in u.value.model.members){if(!Object.prototype.hasOwnProperty.call(u.value.model.members,e))continue;const n=u.value.model.members[e];t.push({label:e,value:{playerId:e,displayName:n.displayName,roleId:m(n.role)}})}c.value=t,c.value.length===1&&(l.value=c.value[0].value)}j(l,C),j(i,C),Y(C);async function C(){if(r.value=void 0,g.value=void 0,l.value&&i.value){R.value=!0;const t=await $.post(`/guilds/${u.value.id}/validateEditRole`,{playerId:l.value.playerId,role:i.value.id}),e=t.data.changes;r.value=[],Object.entries(e).forEach(n=>{const[w,N]=n;r.value.push({playerId:w,newRole:N,displayName:u.value.model.members[w].displayName||"n/a",oldRole:u.value.model.members[w].role});const a=r.value.findIndex(k=>k.playerId===l.value?.playerId);if(a>0){const k=r.value[a];r.value.splice(a,1),r.value.unshift(k)}}),Object.keys(e).length>0&&(g.value=t.data),R.value=!1}else l.value||(i.value=void 0)}const{showSuccessNotification:F}=ae();async function U(){await $.post(`/guilds/${u.value.id}/editRole`,{playerId:l.value?.playerId,role:i.value?.id,expectedChanges:g.value?.changes}),F(`${l.value?.displayName} is now a ${i.value?.displayName}.`),V()}function I(t){return t==="Leader"?"primary":"neutral"}const z=h(()=>u.value.model.lifecyclePhase==="Closed"?"Guild is closed.":O.value?void 0:"Guild has no members.");return(t,e)=>{const n=L("b-spinner"),w=L("b-row"),N=L("fa-icon");return p(),_(o(te),{"modal-title":"Change a Guild Member's Role",action:U,"trigger-button-label":"Change a Role","trigger-button-disabled-tooltip":z.value,"ok-button-label":"Change Role","ok-button-disabled-tooltip":T.value,permission:"api.guilds.edit_roles",onShow:A,"data-testid":"action-change-role"},{default:s(()=>[e[6]||(e[6]=f("div",{class:"tw-mb-1 tw-font-semibold"},"1. Select a Guild Member",-1)),d(o(G),{"model-value":l.value,options:c.value,placeholder:"Select a player...","search-function":D,"onUpdate:modelValue":e[0]||(e[0]=a=>l.value=a)},{option:s(({option:a})=>[f("div",oe,[f("span",null,[v(y(a.value?.displayName)+" ",1),d(o(x),{variant:I(a.value.roleId)},{default:s(()=>[v(y(o(m)(a.value.roleId)),1)],void 0,!0),_:2},1032,["variant"])]),f("span",se,y(a.value.playerId),1)])]),_:1},8,["model-value","options"]),f("div",{class:B(["tw-font-semibold tw-my-3",{"tw-text-neutral-400":!l.value}])},"2. Select a New Role",2),d(o(G),{"model-value":i.value,options:E.value,placeholder:l.value?"Select a role...":"Select a guild member first",disabled:!l.value,"onUpdate:modelValue":e[1]||(e[1]=a=>i.value=a)},null,8,["model-value","options","placeholder","disabled"]),f("div",{class:B(["tw-mb-1",["tw-my-3 tw-font-semibold",{"tw-text-neutral-400":!l.value||!i.value}]])},"3. Preview Role Changes",2),R.value?(p(),S("div",ie,[d(w,{class:"justify-content-center mt-5"},{default:s(()=>[d(n,{class:"mt-4",label:"Loading..."})],void 0,!0),_:1})])):r.value?r.value.length==0?(p(),_(o(J),{key:2,title:"No Changes to Roles"},{default:s(()=>e[2]||(e[2]=[v("This change is no-op, invalid, or the resulting guild state would break the role invariants. Contact Metaplay if you think this is a bug!",-1)]),void 0,!0),_:1,__:[2]})):(p(),_(o(W),{key:3,showBorder:""},{default:s(()=>[(p(!0),S(X,null,Z(r.value,a=>(p(),_(o(q),{class:"tw-px-5",key:a.displayName},{"top-right":s(()=>[d(o(ee),{to:`/players/${a.playerId}`},{default:s(()=>e[3]||(e[3]=[v("View player",-1)]),void 0,!0),_:2,__:[3]},1032,["to"])]),"bottom-left":s(()=>[e[4]||(e[4]=v("Role will be changed from ",-1)),d(o(x),{variant:I(a.oldRole)},{default:s(()=>[v(y(o(m)(a.oldRole)),1)],void 0,!0),_:2},1032,["variant"]),e[5]||(e[5]=v(" to ",-1)),d(o(x),{variant:I(a.newRole)},{default:s(()=>[v(y(o(m)(a.newRole)),1)],void 0,!0),_:2},1032,["variant"])]),default:s(()=>[f("span",null,[d(N,{icon:"user"}),v(" "+y(a.displayName||"n/a"),1)])],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})):(p(),S("div",re,"Choose a player and a role to preview the results."))],void 0,!0),_:1,__:[6]},8,["trigger-button-disabled-tooltip","ok-button-disabled-tooltip"])}}});export{fe as default};
