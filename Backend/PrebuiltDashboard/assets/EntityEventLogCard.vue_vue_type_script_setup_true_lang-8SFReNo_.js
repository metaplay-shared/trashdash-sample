import{d as L,E as $,c as l,h as p,i as K,co as b,K as q,bs as M,b7 as F,e as G,o as H,f as x}from"./index-jY1EWd09.js";import{E as A,a as B,b as R,w as z,g as N,M as V}from"./MetaEventStreamCard-BR93ljz-.js";import{A as h}from"./apiPoller-BsS_UEVQ.js";import{g as O}from"./analyticsEvents-CULxlf4Q.js";const Q=L({__name:"EntityEventLogCard",props:{title:{default:void 0},entityKind:{},entityId:{},entityResetTimestamp:{default:null},utilitiesMode:{default:"filter"},searchPreHighlight:{default:""},freezeSearch:{type:Boolean},keywordPreFilters:{default:()=>[]},eventTypePreFilters:{default:()=>[]},maxHeight:{default:"30rem"},fetchPollingInterval:{default:5e3},fetchPageSize:{default:1e3},folding:{default:"session"},showViewMoreLink:{type:Boolean,default:!0},excludedTypes:{default:()=>[]},wrapRepeatingEvents:{type:Boolean,default:!0}},emits:["stats"],setup(r,{emit:E}){const P=F(),S=M(),t=r,I=E,{data:T}=$(O()),k=l(()=>{const e=(T.value??[]).map(n=>[n.type.split(",")[0],n]);return Object.fromEntries(e)});let o,f,s,y;const u=p(!1);K(async()=>{D.value?await v():u.value=!1}),b(()=>{o?.stop(),s?.stop()});const d=l(()=>{let e="";if(typeof t.entityId=="string"?e=t.entityId:e=t.entityId(),!e)throw new Error("Entity Id cannot be empty or undefined.");return e});q([()=>d.value,()=>t.entityResetTimestamp],async()=>{await v()});const m=l(()=>{if(t.entityKind==="Player")return`/players/${d.value}/eventLog`;if(t.entityKind==="Guild")return`/guilds/${d.value}/eventLog`;throw new Error("Invalid entityKind for EntityEventLogCard: "+t.entityKind)}),i=p([]),c=p(!1);async function v(){c.value=!1,i.value=[],u.value=!0,o&&(o.stop(),o=void 0),s&&(s.stop(),s=void 0);const e=(await S.request({method:"GET",url:m.value,params:{startCursor:"$newest",numEntries:1,scanDirection:"towardsNewer"}})).data;if(e.failedWithDesync)throw new Error("Initial request from cursor $newest should never result in a desync.");const n=e.startCursor;f=n,y=n,o=new h(()=>t.fetchPollingInterval,"GET",m.value,()=>({startCursor:f,numEntries:t.fetchPageSize,scanDirection:"towardsNewer"}),a=>{c.value=!0,a.failedWithDesync?v():(a.entries.length>0&&(i.value=i.value.concat(a.entries),w()),f=a.continuationCursor)}),s=new h(100,"GET",m.value,()=>({startCursor:y,numEntries:t.fetchPageSize,scanDirection:"towardsOlder"}),a=>{c.value=!0,a.failedWithDesync?v():(a.entries.length>0&&(i.value=a.entries.concat(i.value),w(),y=a.continuationCursor),a.entries.length<t.fetchPageSize&&(s?.stop(),u.value=!1))})}const C=l(()=>{if(i.value.length>0){let e=i.value.filter(n=>!t.excludedTypes.includes(n.payload.$type)).map(n=>new A(n.collectedAt,k.value[n.payload.$type]?.displayName??n.payload.$type,n.payload.eventDescription,n.uniqueId,n,"","timeline",`/entityEventLog/${t.entityKind}/${d.value}?search=${n.uniqueId}`));return t.folding==="session"?e=B(e):t.folding==="day"&&(e=R(e)),t.wrapRepeatingEvents&&(e=z(e)),I("stats",N(e)),e}else return c.value?[]:null});function w(){if(i.value.length>0)for(let e=1;e<i.value.length;e++)i.value[e].sequentialId!==i.value[e-1].sequentialId+1&&console.warn(`Gap in event log: entry ${i.value[e].sequentialId} follows ${i.value[e-1].sequentialId}`)}const D=l(()=>P.doesHavePermission(g.value)),g=l(()=>{if(t.entityKind==="Player")return"api.players.view";if(t.entityKind==="Guild")return"api.guilds.view";throw new Error("Invalid entityKind for EntityEventLogCard: "+t.entityKind)});return(e,n)=>(H(),G(x(V),{title:r.title??`Latest ${r.entityKind} Events`,icon:"clipboard-list",eventStream:C.value,eventStreamLoading:u.value,utilitiesMode:r.utilitiesMode,searchPreHighlight:r.searchPreHighlight,keywordPreFilters:r.keywordPreFilters,eventTypePreFilters:r.eventTypePreFilters,maxHeight:r.maxHeight,permission:g.value,showTimeDeltas:r.folding!=="day",showViewMoreLink:r.showViewMoreLink,"allow-pausing":"","data-testid":"entity-event-log-card"},null,8,["title","eventStream","eventStreamLoading","utilitiesMode","searchPreHighlight","keywordPreFilters","eventTypePreFilters","maxHeight","permission","showTimeDeltas","showViewMoreLink"]))}});export{Q as _};
