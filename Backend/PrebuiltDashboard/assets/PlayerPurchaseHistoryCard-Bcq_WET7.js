import{d as M,C as N,c as L,a as d,o as u,F as H,b as B,e as y,w as s,k as a,t as i,f as n,_ as v,a7 as Z,q as m,ab as ee,E as te,h as R,K as se,r as O,m as $,j as o,s as re,v as ne,x as p,y as k,D,Q as ae,bm as oe,U as ue,bk as ie,bs as de,bt as le}from"./index-jY1EWd09.js";import ce from"./MetaListCard-1ZrdC8ii.js";import{M as S,a as P,b as F,c as g}from"./metaListUtils-B-xQ0HnD.js";import{a as pe}from"./players-Dfl1Givn.js";import{a as fe}from"./rewardUtils-DXeMkd5o.js";import{_ as me}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CTycXHot.js";import"./utils-B01yCWQ7.js";import"./_baseIteratee-FGZghVLZ.js";import"./isSymbol-B-tfGeoT.js";import"./identity-DKeuBCMA.js";import"./MInputText.vue_vue_type_script_setup_true_lang-Wwv8TYAB.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-CYiRxbPX.js";import"./debounce-DkFP0rfT.js";import"./MInputMultiSelectCheckbox.vue_vue_type_script_setup_true_lang-BmEacL49.js";import"./MInputCheckbox.vue_vue_type_script_setup_true_lang-Bzg4Lkt_.js";import"./MInputSingleSelectRadio-BM2VfYc3.js";import"./index-Dec9dGh3.js";import"./button-group-DH69WWlM.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-CihjvaoM.js";import"./index-qe4CXcF2.js";const he={key:0},ge={key:1},ye={class:"text-danger"},ve=M({__name:"OfferSpan",props:{offer:{type:Object,required:!0}},setup(_){const h=_,x=N(),b=L(()=>h.offer.$type==="Metaplay.Core.InAppPurchase.ResolvedPurchaseMetaRewards"?h.offer.rewards.map(f=>fe(f).getDisplayValue(f)):x.gameSpecific.iapContents.find(f=>f.$type===h.offer.$type)?.getDisplayContent(h.offer)??null);return(f,T)=>b.value?(u(),d("span",he,[(u(!0),d(H,null,B(b.value,c=>(u(),y(n(v),{class:"tw-ml-1",key:c},{default:s(()=>[a(i(c),1)],void 0,!0),_:2},1024))),128))])):(u(),d("span",ge,[Z(f.$slots,"default",{},()=>[m("span",ye,"Error: undefined offer type '"+i(_.offer.$type)+"'",1)])]))}}),_e={key:0},be={class:"tw-mr-1"},we={key:0,class:"tw-text-neutral-500"},Se={key:1},Pe={class:"tw-flex tw-items-center tw-gap-0.5 tw-p-1"},xe={class:"text-muted"},Ie={key:0,class:"text-muted"},Ce={key:1},Re={key:0,class:"text-muted"},$e={key:1},ke={key:2},De={key:0,class:"text-muted"},Te={key:1},Ae={key:0},Ve={key:1},et=M({__name:"PlayerPurchaseHistoryCard",props:{playerId:{}},setup(_){const h=_,x=de(),b=le(),f=N(),T=ee(),{data:c,refresh:U}=te(pe(h.playerId)),I=R();function q(e){return`${e.purchase.transactionId}-${e.purchase.purchaseTime}`}se(c,j,{immediate:!0});function j(){const e=[];if(c.value){Object.keys(c.value.model.pendingInAppPurchases).forEach(l=>{e.push({isPending:!0,purchase:c.value.model.pendingInAppPurchases[l]})});const t=T.featureFlags.iapPlatformRefundSupport;for(const l of c.value.model.fullInAppPurchaseHistory)e.push({platformRefundSupport:t[l.platform]??"NotSupported",purchase:l});for(const l of c.value.model.duplicateInAppPurchaseHistory)e.push({isDuplicate:!0,purchase:l});for(const l of c.value.model.failedInAppPurchaseHistory)e.push({purchase:l})}I.value=e}const E=["purchase.platform","purchase.productId","purchase.transactionId","purchase.alternativePurchaseId"],G=[new S("Purchase time","purchase.purchaseTime",P.Ascending),new S("Purchase time","purchase.purchaseTime",P.Descending),new S("Price","purchase.referencePrice",P.Ascending),new S("Price","purchase.referencePrice",P.Descending)],z=R(1),K=L(()=>[F.asDynamicFilterSet(I.value,"product-id",e=>e.purchase.productId),new F("status",[new g("Successful",e=>e.purchase.status==="Successful"),new g("Failed",e=>e.purchase.status==="Failed"),new g("Pending validation",e=>e.purchase.status==="PendingValidation"),new g("Refunded",e=>e.purchase.status==="Refunded"),new g("Receipt already used",e=>e.purchase.status==="ReceiptAlreadyUsed"),new g("Other",e=>!["Successful","PendingValidation","Refunded","ReceiptAlreadyUsed","Failed"].includes(e.purchase.status))])]),C=R();async function Q(){await x.post(`/players/${c.value.id}/refund/${C.value.purchase.transactionId}`),b.showSuccessNotification("Refunded successfully."),U()}function w(e){const l={PendingValidation:{text:"Pending validation",statusClass:"text-warning",badgeVariant:"neutral"},Successful:{text:"Successful",statusClass:"text-success",badgeVariant:"success"},Failed:{text:"Failed",statusClass:"text-danger",badgeVariant:"danger"},ReceiptAlreadyUsed:{text:"Receipt already used",statusClass:"text-warning",badgeVariant:"neutral"},Refunded:{text:"Refunded",statusClass:"text-warning",badgeVariant:"neutral"},UserDeclined:{text:"Declined by user",statusClass:"text-warning",badgeVariant:"neutral"},Abandoned:{text:"Purchase interrupted",statusClass:"text-warning",badgeVariant:"neutral"}}[e.purchase.status];return l||{text:e.purchase.status,statusClass:"text-warning",badgeVariant:"neutral"}}function A(e){const t=f.gameSpecific.iapContents.find(l=>l.$type===e.purchase.dynamicContent.$type);return t?t.getDisplayContent(e.purchase.dynamicContent).join(", "):null}function W(e){if(e.purchase.status==="Refunded")return"This purchase has already been refunded.";if(e.purchase.status==="PendingValidation")return"The purchase hasn't yet been completed.";if(e.purchase.status!=="Successful")return"Only successful purchases can be refunded.";if(e.isPending)return"The client must claim the purchase before it can be refunded.";if(e.platformRefundSupport==="NotSupported")return`Refunding is not supported on the ${e.purchase.platform} platform.`;if(e.platformRefundSupport==="NotConfigured")return`${e.purchase.platform} refunds have not been configured.`}function Y(e,t=36){return e.length<=t?e:`${e.substring(0,t-3)}...`}return(e,t)=>{const l=O("meta-reward-badge"),J=O("meta-no-seatbelts");return n(c)?(u(),d("div",_e,[o(n(ce),{class:"tw-mb-4",title:"Purchase History",icon:"money-check-alt",itemList:I.value,getItemKey:q,searchFields:E,sortOptions:G,defaultSortOption:z.value,filterSets:K.value,emptyMessage:"No purchases... yet!","data-testid":"player-purchase-history-card"},{"item-card":s(({item:r})=>[o(n(re),{extraMListItemMargin:""},{header:s(()=>[o(n(p),{noLeftPadding:""},{badge:s(()=>[r.isPending?(u(),y(n(v),{key:0,variant:"warning"},{default:s(()=>[...t[2]||(t[2]=[a("Pending",-1)])],void 0,!0),_:1})):r.isDuplicate?(u(),y(n(v),{key:1},{default:s(()=>[...t[3]||(t[3]=[a("Duplicate",-1)])],void 0,!0),_:1})):(u(),y(n(v),{key:2,variant:w(r).badgeVariant},{default:s(()=>[a(i(w(r).text),1)],void 0,!0),_:2},1032,["variant"]))]),"top-right":s(()=>[o(n(k),{instant:n(D).fromISO(r.purchase.purchaseTime),showAs:"dateTime"},null,8,["instant"])]),"bottom-left":s(()=>[m("span",Pe,[a(i(Y(r.purchase.transactionId)),1),o(n(ie),{contents:r.purchase.transactionId},null,8,["contents"])])]),"bottom-right":s(()=>[a(i(r.purchase.platform),1)]),default:s(()=>[m("span",be,i(r.purchase.productId),1),r.purchase.subscriptionQueryResult===null?(u(),d("span",we,"($"+i(r.purchase.referencePrice.toFixed(2))+")",1)):(u(),d("span",Se,[t[0]||(t[0]=a("(",-1)),o(n(ue),{content:"Subscription purchases are not applied directly towards the player's total spend. Please see Subscription History instead."},{default:s(()=>[a("$"+i(r.purchase.referencePrice.toFixed(2)),1)],void 0,!0),_:2},1024),t[1]||(t[1]=a(")",-1))]))],void 0,!0),_:2},1024)]),default:s(()=>[o(n(ne),{showBorder:"",striped:""},{default:s(()=>[o(n(p),{condensed:""},{"top-right":s(()=>[a(i(r.purchase.platform),1)]),default:s(()=>[t[4]||(t[4]=a("Platform",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[m("span",xe,i(r.purchase.transactionId),1)]),default:s(()=>[t[5]||(t[5]=a("Transaction ID",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[r.purchase.alternativePurchaseId===null?(u(),d("span",Ie,"None")):(u(),d("span",Ce,i(r.purchase.alternativePurchaseId),1))]),default:s(()=>[t[6]||(t[6]=a("Alternative Purchase ID",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[a(i(r.purchase.productId),1)]),default:s(()=>[t[7]||(t[7]=a("Product ID",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[a(i(r.purchase.platformProductId),1)]),default:s(()=>[t[8]||(t[8]=a("Platform Product ID",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[a("$"+i(r.purchase.referencePrice.toFixed(2)),1)]),default:s(()=>[t[9]||(t[9]=a("Reference Price",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[r.purchase.dynamicContent?A(r)?(u(),d("span",$e,i(A(r)),1)):(u(),d("span",ke,"Unknown "+i(r.purchase.dynamicContent.$type),1)):(u(),d("span",Re,"None"))]),default:s(()=>[t[10]||(t[10]=a("Related Offer",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[!r.purchase.resolvedContent&&!r.purchase.resolvedDynamicContent?(u(),d("span",De,"None")):(u(),d("span",Te,[r.purchase.resolvedContent?(u(),d("span",Ae,[o(ve,{offer:r.purchase.resolvedContent},null,8,["offer"])])):$("",!0),r.purchase.resolvedDynamicContent?(u(),d("span",Ve,[(u(!0),d(H,null,B(r.purchase.resolvedDynamicContent.rewards,(V,X)=>(u(),y(l,{key:X,reward:V},null,8,["reward"]))),128))])):$("",!0)]))]),default:s(()=>[t[11]||(t[11]=a("Content",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[o(n(k),{instant:n(D).fromISO(r.purchase.purchaseTime),showAs:"dateTime"},null,8,["instant"])]),default:s(()=>[t[12]||(t[12]=a("Purchase Time",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[o(n(k),{instant:n(D).fromISO(r.purchase.claimTime),showAs:"dateTime"},null,8,["instant"])]),default:s(()=>[t[13]||(t[13]=a("Claim Time",-1))],void 0,!0),_:2},1024),o(n(p),{condensed:""},{"top-right":s(()=>[m("div",{class:ae(["text-right text-break-word",w(r).statusClass])},i(w(r).text),3)]),default:s(()=>[t[14]||(t[14]=a("Status",-1))],void 0,!0),_:2},1024)],void 0,!0),_:2},1024),o(n(oe),{class:"tw-mt-2"},{default:s(()=>[o(n(me),{"trigger-button-disabled-tooltip":W(r),"modal-title":"Refund In-App-Purchase",action:Q,"trigger-button-label":"Issue Refund","trigger-button-size":"small",variant:"danger","ok-button-label":"Refund",permission:"api.players.iap_refund",onShow:V=>C.value=r},{default:s(()=>[m("p",null,[t[15]||(t[15]=a("You can issue a refund for the purchase ",-1)),o(n(v),null,{default:s(()=>[a(i(C.value?.purchase.transactionId),1)],void 0,!0),_:1}),a(". The game server will request the "+i(r.purchase.platform)+" store to refund the player. The in-game items will be revoked from the player if revocation has been implemented in this game.",1)]),t[16]||(t[16]=m("span",{class:"tw-text-xs+ tw-text-neutral-500"},"Note: On some platforms, refunds requested by the player directly from the store are not available to display here. Requesting a refund multiple times from here will not issue the refund more than once.",-1)),o(J,{class:"tw-mt-4"})],void 0,!0),_:2},1032,["trigger-button-disabled-tooltip","onShow"])],void 0,!0),_:2},1024)],void 0,!0),_:2},1024)]),_:1},8,["itemList","defaultSortOption","filterSets"])])):$("",!0)}}});export{et as default};
